<!-- Generated by SpecStory, Markdown v2.0.0 -->

# 2025-12-19 19:11:06Z

<!-- Claude Code Session 0c73c181-9d54-4d0e-9b35-84da5111e4a2 (2025-12-19_19-11-06Z) -->

_**User**_

RAM炸了 WINDOWS SERVER吃到10GB 看一下啥情況

---

_**Agent (claude-sonnet-4-5-20250929)**_

<think><details><summary>Thought Process</summary>
用戶說「RAM炸了 WINDOWS SERVER吃到10GB 看一下啥情況」，這是要我檢查專案可能導致記憶體問題的原因。

首先，我需要了解這個專案的結構和內容，看看是否有什麼程式碼或配置會導致高記憶體使用。

從上下文來看，這是一個「甘特圖專案管理」的專案，而且是在 Web 應用分類中（HTML, JavaScript, Vercel）。

我應該：
1. 先查看專案結構
2. 檢查 JavaScript 代碼，看是否有記憶體洩漏的問題
3. 查看是否有大量資料載入或循環引用
4. 檢查是否有定時器沒有清理
5. 查看是否有大量 DOM 操作

讓我先看一下專案結構。
</details></think>

_**Agent (claude-sonnet-4-5-20250929)**_

我來幫你檢查這個甘特圖專案的記憶體問題。讓我先看一下專案結構和程式碼。

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="bash" data-tool-name="Bash"><details>
<summary>Tool use: **Bash**</summary>
 列出專案中的主要檔案

`find . -type f -name "*.html" -o -name "*.js" -o -name "*.json" | grep -v node_modules | head -20`
```
./.vercel/project.json
./tsconfig.node.json
./index.html
./tailwind.config.js
./vercel.json
./dist/index.html
./dist/assets/index-DDMuGLoL.js
./.specstory/.project.json
./backend/vercel.json
./backend/server.js
./backend/package-lock.json
./backend/package.json
./backend/tasks.json
./backend/storage.js
./package-lock.json
./package.json
./tsconfig.json
./postcss.config.js
./src/index.html
```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="grep" data-tool-name="Glob"><details>
<summary>Tool use: **Glob**</summary>
 pattern `**/*.html`
```
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/dist/index.html
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/index.html
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/node_modules/@mapbox/node-pre-gyp/lib/util/nw-pre-gyp/index.html
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/node_modules/tslib/tslib.es6.html
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/node_modules/tslib/tslib.html
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/index.html
```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="grep" data-tool-name="Glob"><details>
<summary>Tool use: **Glob**</summary>
 pattern `**/*.js`
```
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/balanced-match/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/send/node_modules/ms/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/is-number/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/nodemon/node_modules/ms/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/ipaddr.js/ipaddr.min.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/forwarded/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/binary-extensions/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/brace-expansion/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/to-regex-range/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/normalize-path/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/is-glob/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/glob-parent/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/fill-range/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/readdirp/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/anymatch/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/safer-buffer/dangerous.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/mime-db/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/inherits/inherits_browser.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/ms/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/bytes/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/raw-body/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/destroy/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/serve-static/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/toidentifier/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/proxy-addr/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/mime-types/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/path-to-regexp/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/statuses/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/safe-buffer/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/http-errors/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/merge-descriptors/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/on-finished/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/encodeurl/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/content-type/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/content-disposition/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/finalhandler/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/object-assign/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/body-parser/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/cookie/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/accepts/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/math-intrinsics/abs.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/gopd/gOPD.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/es-object-atoms/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/concat-map/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/es-errors/eval.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/picomatch/lib/constants.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/is-binary-path/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/minimatch/minimatch.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/braces/lib/compile.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/inherits/inherits.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/setprototypeof/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/type-is/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/send/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/negotiator/lib/charset.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/parseurl/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/range-parser/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/escape-html/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/chokidar/lib/constants.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/cookie-signature/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/math-intrinsics/floor.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/hasown/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/es-define-property/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/gopd/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/dunder-proto/get.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/call-bound/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/call-bind-apply-helpers/actualApply.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/ee-first/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/es-errors/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/is-extglob/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/picomatch/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/get-proto/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/media-typer/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/braces/lib/constants.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/unpipe/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/negotiator/lib/encoding.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/methods/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/etag/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/fresh/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/depd/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/vary/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/send/node_modules/encodeurl/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/express/lib/application.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/es-object-atoms/test/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/side-channel-weakmap/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/side-channel-list/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/side-channel/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/call-bind-apply-helpers/applyBind.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/get-intrinsic/test/GetIntrinsic.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/mime/mime.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/object-inspect/example/all.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/side-channel-map/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/braces/lib/expand.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/utils-merge/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/negotiator/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/qs/test/empty-keys-cases.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/chokidar/lib/fsevents-handler.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/body-parser/lib/types/json.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/array-flatten/array-flatten.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/gopd/test/index.js
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/node_modules/es-define-property/test/index.js
(Results are truncated. Consider using a more specific path or pattern.)
```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<think><details><summary>Thought Process</summary>
好的，讓我檢查主要的源代碼檔案。從結構來看，這個專案有：
- src/ 目錄（源代碼）
- backend/ 目錄（後端伺服器）
- dist/ 目錄（編譯輸出）

我應該檢查：
1. 主要的 JavaScript/TypeScript 源代碼
2. 後端 server.js
3. 看看是否有大量數據或循環問題

讓我先看源代碼的結構。
</details></think>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="grep" data-tool-name="Glob"><details>
<summary>Tool use: **Glob**</summary>
 pattern `src/**/*`
```
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/main.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/types/index.ts
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/index.html
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/AppV2.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/index.css
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/components/ui/ContextPanel.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/components/Layout/NavigationIsland.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/components/Gantt/CalendarView.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/components/Gantt/GanttChart.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/components/Sidebar.tsx
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/hooks/useTasks.ts
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/hooks/useNotes.ts
/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/src/api/client.ts
```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./backend/server.js`
```
     1→import express from 'express';
     2→import cors from 'cors';
     3→import {
     4→  loadTasks,
     5→  saveTasks,
     6→  normalizeWorkspaceState,
     7→  loadWorkspace,
     8→  saveWorkspace,
     9→  listWorkspaces,
    10→  createWorkspace,
    11→  deleteWorkspace,
    12→  DEFAULT_WORKSPACE_ID,
    13→} from './storage.js';
    14→
    15→const app = express();
    16→const PORT = process.env.PORT || 3001;
    17→
    18→app.use(cors({ origin: true, credentials: false }));
    19→app.use(express.json({ limit: '15mb' }));
    20→
    21→app.get('/health', (_req, res) => {
    22→  res.json({ status: 'ok', source: 'gantt-manager-api' });
    23→});
    24→
    25→app.get('/tasks', async (req, res) => {
    26→  const workspaceId = typeof req.query.workspaceId === 'string' && req.query.workspaceId
    27→    ? req.query.workspaceId
    28→    : DEFAULT_WORKSPACE_ID;
    29→
    30→  try {
    31→    const state =
    32→      workspaceId === DEFAULT_WORKSPACE_ID
    33→        ? await loadTasks()
    34→        : await loadWorkspace(workspaceId);
    35→
    36→    if (!state) {
    37→      return res.status(404).json({ error: 'Workspace not found' });
    38→    }
    39→
    40→    res.json(state);
    41→  } catch (error) {
    42→    console.error('[API] Failed to read tasks', error);
    43→    res.status(500).json({ error: 'Failed to read tasks' });
    44→  }
    45→});
    46→
    47→app.put('/tasks', async (req, res) => {
    48→  const workspaceId = typeof req.query.workspaceId === 'string' && req.query.workspaceId
    49→    ? req.query.workspaceId
    50→    : DEFAULT_WORKSPACE_ID;
    51→  const payload = req.body;
    52→  const payloadSize = JSON.stringify(payload).length;
    53→
    54→  const normalized = normalizeWorkspaceState(payload);
    55→  const taskCount = normalized.tasks.length;
    56→
    57→  console.log(
    58→    `[API] PUT /tasks (workspace=${workspaceId}) - payload size: ${payloadSize} bytes, task count: ${taskCount}`,
    59→  );
    60→
    61→  // Check for large payloads that might contain base64 images
    62→  if (payloadSize > 10 * 1024 * 1024) {
    63→    console.warn(
    64→      `[API] PUT /tasks (workspace=${workspaceId}) - Large payload detected: ${(
    65→        payloadSize /
    66→        1024 /
    67→        1024
    68→      ).toFixed(2)}MB`,
    69→    );
    70→  }
    71→
    72→  try {
    73→    if (workspaceId === DEFAULT_WORKSPACE_ID) {
    74→      await saveTasks(normalized);
    75→    } else {
    76→      await saveWorkspace(workspaceId, normalized);
    77→    }
    78→    console.log(`[API] PUT /tasks - Successfully saved ${taskCount} tasks (workspace=${workspaceId})`);
    79→    res.json({ success: true, count: taskCount });
    80→  } catch (error) {
    81→    console.error('[API] PUT /tasks - Failed to write tasks');
    82→    console.error('[API] Error details:', {
    83→      message: error?.message,
    84→      stack: error?.stack,
    85→      code: error?.code,
    86→      payloadSize,
    87→      taskCount
    88→    });
    89→    res.status(500).json({
    90→      error: 'Failed to persist tasks',
    91→      detail: error?.message ?? 'unknown error',
    92→      code: error?.code
    93→    });
    94→  }
    95→});
    96→
    97→app.get('/workspaces', async (_req, res) => {
    98→  try {
    99→    const summaries = await listWorkspaces();
   100→    res.json({ workspaces: summaries });
   101→  } catch (error) {
   102→    console.error('[API] GET /workspaces - Failed to list workspaces', error);
   103→    res.status(500).json({ error: 'Failed to list workspaces' });
   104→  }
   105→});
   106→
   107→app.post('/workspaces', async (req, res) => {
   108→  const { name, owner, range } = req.body || {};
   109→  try {
   110→    const created = await createWorkspace({
   111→      name,
   112→      owner,
   113→      range:
   114→        range && typeof range === 'object'
   115→          ? {
   116→              start: typeof range.start === 'string' ? range.start : '',
   117→              end: typeof range.end === 'string' ? range.end : '',
   118→            }
   119→          : undefined,
   120→    });
   121→    res.status(201).json(created);
   122→  } catch (error) {
   123→    console.error('[API] POST /workspaces - Failed to create workspace', error);
   124→    res.status(500).json({ error: 'Failed to create workspace', detail: error?.message });
   125→  }
   126→});
   127→
   128→app.patch('/workspaces/:workspaceId', async (req, res) => {
   129→  const workspaceId = req.params.workspaceId;
   130→  const { status, owner, name } = req.body || {};
   131→
   132→  try {
   133→    const current = await loadWorkspace(workspaceId);
   134→    if (!current) {
   135→      return res.status(404).json({ error: 'Workspace not found' });
   136→    }
   137→
   138→    const metaOverride = {};
   139→    if (typeof status === 'string' && status.trim()) {
   140→      metaOverride.status = status.trim();
   141→    }
   142→    if (typeof owner === 'string') {
   143→      metaOverride.owner = owner;
   144→    }
   145→    if (typeof name === 'string' && name.trim()) {
   146→      metaOverride.name = name.trim();
   147→    }
   148→
   149→    await saveWorkspace(workspaceId, current, metaOverride);
   150→    const summaries = await listWorkspaces();
   151→    const updated = summaries.find((item) => item.id === workspaceId);
   152→
   153→    res.json({ workspace: updated || null });
   154→  } catch (error) {
   155→    console.error('[API] PATCH /workspaces - Failed to update workspace', error);
   156→    res.status(500).json({ error: 'Failed to update workspace', detail: error?.message });
   157→  }
   158→});
   159→
   160→app.delete('/workspaces/:workspaceId', async (req, res) => {
   161→  const workspaceId = req.params.workspaceId;
   162→
   163→  try {
   164→    if (workspaceId === DEFAULT_WORKSPACE_ID) {
   165→      return res.status(400).json({ error: 'Default workspace cannot be deleted' });
   166→    }
   167→
   168→    const removed = await deleteWorkspace(workspaceId);
   169→    if (!removed) {
   170→      return res.status(404).json({ error: 'Workspace not found' });
   171→    }
   172→
   173→    res.json({ success: true });
   174→  } catch (error) {
   175→    console.error('[API] DELETE /workspaces - Failed to delete workspace', error);
   176→    res.status(500).json({ error: 'Failed to delete workspace', detail: error?.message });
   177→  }
   178→});
   179→
   180→if (!process.env.VERCEL) {
   181→  app.listen(PORT, () => {
   182→    console.log(`Gantt Manager API listening on port ${PORT}`);
   183→  });
   184→}
   185→
   186→export default app;
   187→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./package.json`
```
     1→{
     2→  "name": "rainbow-gantt-v2",
     3→  "private": true,
     4→  "version": "0.0.0",
     5→  "type": "module",
     6→  "scripts": {
     7→    "dev": "vite",
     8→    "build": "vite build",
     9→    "preview": "vite preview"
    10→  },
    11→  "dependencies": {
    12→    "@upstash/redis": "^1.35.7",
    13→    "@vercel/kv": "^3.0.0",
    14→    "clsx": "^2.0.0",
    15→    "framer-motion": "^10.16.4",
    16→    "lucide-react": "^0.292.0",
    17→    "react": "^18.2.0",
    18→    "react-dom": "^18.2.0",
    19→    "redis": "^5.10.0",
    20→    "tailwind-merge": "^2.0.0"
    21→  },
    22→  "devDependencies": {
    23→    "@types/react": "^18.2.37",
    24→    "@types/react-dom": "^18.2.15",
    25→    "@vercel/node": "^5.5.15",
    26→    "@vitejs/plugin-react": "^4.2.0",
    27→    "autoprefixer": "^10.4.16",
    28→    "postcss": "^8.4.31",
    29→    "tailwindcss": "^3.3.5",
    30→    "typescript": "^5.2.2",
    31→    "vite": "^5.0.0"
    32→  }
    33→}
    34→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<think><details><summary>Thought Process</summary>
好的，這是一個 React + TypeScript 的專案。讓我檢查主要的前端代碼，特別是可能造成記憶體問題的部分：

1. AppV2.tsx（主應用）
2. GanttChart.tsx（甘特圖組件）
3. CalendarView.tsx（日曆視圖）
4. useTasks.ts 和 useNotes.ts（自定義 hooks）

記憶體問題可能來自：
- 大量任務數據沒有釋放
- 事件監聽器沒有清理
- 定時器沒有清除
- React 組件沒有正確卸載
- 大量 base64 圖片（從 server.js 看到有 15MB 的 limit）

讓我先看主要組件。
</details></think>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./src/AppV2.tsx`
```
     1→import React, { useState, useMemo } from 'react';
     2→import { NavigationIsland } from './components/Layout/NavigationIsland';
     3→import { CalendarView } from './components/Gantt/CalendarView';
     4→import { GanttChart } from './components/Gantt/GanttChart';
     5→import { ContextPanel } from './components/ui/ContextPanel';
     6→import { useTasks } from './hooks/useTasks';
     7→import { useNotes, LearningNote } from './hooks/useNotes';
     8→import { motion, AnimatePresence } from 'framer-motion';
     9→import { Plus, Search, Calendar as CalendarIcon, BarChart3, List, Loader2, FlaskConical, Link as LinkIcon, BookOpen, X, Save, FileText, Trash2, Check, ChevronDown, Upload, Image as ImageIcon, PlayCircle, CheckCircle, Settings } from 'lucide-react';
    10→import { Task, TaskCategory, Material } from './types';
    11→
    12→// Retro Panel Component
    13→const Panel = ({ children, className = '' }: { children: React.ReactNode, className?: string }) => (
    14→  <div className={`retro-panel p-6 ${className}`}>
    15→    {children}
    16→  </div>
    17→);
    18→
    19→// 類別顏色映射 - 白色磁帶未來主義
    20→const CATEGORY_COLORS: Record<string, { bg: string; bar: string; text: string }> = {
    21→  'AI賦能': { bg: 'bg-cyan-200', bar: 'bg-cyan-500', text: 'text-cyan-800' },
    22→  '流程優化': { bg: 'bg-amber-200', bar: 'bg-amber-500', text: 'text-amber-800' },
    23→  '產品行銷': { bg: 'bg-fuchsia-200', bar: 'bg-fuchsia-500', text: 'text-fuchsia-800' },
    24→  '品牌行銷': { bg: 'bg-emerald-200', bar: 'bg-emerald-500', text: 'text-emerald-800' },
    25→  '客戶開發': { bg: 'bg-red-200', bar: 'bg-red-500', text: 'text-red-800' },
    26→  '其他': { bg: 'bg-gray-200', bar: 'bg-gray-500', text: 'text-gray-800' },
    27→};
    28→
    29→const getColorForCategory = (category: string) => {
    30→  return CATEGORY_COLORS[category] || CATEGORY_COLORS['其他'];
    31→};
    32→
    33→// 圓餅圖的顏色 (更具科技感)
    34→const PIE_COLORS = ['#06b6d4', '#f59e0b', '#d946ef', '#10b981', '#ef4444', '#6b7280']; // Cyan, Amber, Fuchsia, Emerald, Red, Gray
    35→
    36→interface DeliveryViewProps {
    37→  tasks: Task[];
    38→  isLoading: boolean;
    39→  onOpenTask: (task: Task | null) => void;
    40→  people: string[];
    41→}
    42→
    43→const filterTasksByOwner = (tasks: Task[], filter: string) => {
    44→  if (filter === 'all') return tasks;
    45→  return tasks.filter(t => (t.owner || '').toLowerCase() === filter.toLowerCase());
    46→};
    47→
    48→const DeliveryView = ({ tasks, isLoading, onOpenTask, people }: DeliveryViewProps) => {
    49→  const [viewMode, setViewMode] = useState<'gantt' | 'list'>('gantt');
    50→  const [ownerFilter, setOwnerFilter] = useState<string>('all');
    51→
    52→  // 根據 owner 篩選任務
    53→  const filteredTasks = useMemo(() => filterTasksByOwner(tasks, ownerFilter), [tasks, ownerFilter]);
    54→
    55→  // 計算統計數據（基於篩選後的任務）
    56→  const stats = useMemo(() => {
    57→    const total = filteredTasks.length;
    58→    const completed = filteredTasks.filter(t => t.status === 'completed').length;
    59→    const inProgress = filteredTasks.filter(t => t.status === 'in-progress').length;
    60→    const pending = filteredTasks.filter(t => t.status === 'pending' || t.status === 'unpublished').length;
    61→    const overallProgress = total > 0 ? Math.round((completed / total) * 100) : 0;
    62→
    63→    // 按類別統計
    64→    const byCategory = filteredTasks.reduce((acc, task) => {
    65→      const cat = task.category || '其他';
    66→      if (!acc[cat]) acc[cat] = { total: 0, completed: 0 };
    67→      acc[cat].total++;
    68→      if (task.status === 'completed') acc[cat].completed++;
    69→      return acc;
    70→    }, {} as Record<string, { total: number; completed: number }>);
    71→
    72→    return { total, completed, inProgress, pending, overallProgress, byCategory };
    73→  }, [filteredTasks]);
    74→
    75→  // 計算圓餅圖的分段
    76→  const pieSegments = useMemo(() => {
    77→    const categories = Object.entries(stats.byCategory);
    78→    if (categories.length === 0) return [];
    79→
    80→    let offset = 0;
    81→    return categories.map(([category, data], index) => {
    82→      const percentage = stats.total > 0 ? (data.total / stats.total) * 100 : 0;
    83→      const segment = {
    84→        category,
    85→        percentage,
    86→        offset,
    87→        color: PIE_COLORS[index % PIE_COLORS.length],
    88→        count: data.total
    89→      };
    90→      offset += percentage;
    91→      return segment;
    92→    });
    93→  }, [stats]);
    94→
    95→  return (
    96→    <motion.div
    97→      initial={{ opacity: 0, y: 20 }}
    98→      animate={{ opacity: 1, y: 0 }}
    99→      exit={{ opacity: 0, y: -20 }}
   100→      className="space-y-6 pb-32 h-full flex flex-col pointer-events-auto"
   101→    >
   102→      {/* Top Bar */}
   103→      <div className="flex flex-col xl:flex-row items-start xl:items-center justify-between shrink-0 px-2 gap-4">
   104→        <div>
   105→          <h1 className="text-3xl font-bold text-gray-900 tracking-tighter uppercase">SYS_GANTT_V2 // ACTIVE_PROJECTS</h1>
   106→          <p className="text-gray-600 text-sm mt-1">OPERATIONAL_STATUS: ALL_SYSTEMS_GO</p>
   107→        </div>
   108→        <div className="flex flex-wrap items-center gap-3 pr-16">
   109→           {/* View Switcher - Retro Style */}
   110→           <div className="retro-panel p-1 flex gap-1 pointer-events-auto mr-2">
   111→              <button
   112→                onClick={() => setViewMode('gantt')}
   113→                className={`retro-btn p-2.5 text-sm flex items-center gap-2 ${viewMode === 'gantt' ? 'bg-black text-white' : 'text-gray-700 hover:bg-gray-100'}`}
   114→              >
   115→                <BarChart3 className="w-4 h-4 rotate-90"/>
   116→                GANTT
   117→              </button>
   118→              <button
   119→                onClick={() => setViewMode('list')}
   120→                className={`retro-btn p-2.5 text-sm flex items-center gap-2 ${viewMode === 'list' ? 'bg-black text-white' : 'text-gray-700 hover:bg-gray-100'}`}
   121→              >
   122→                <List className="w-4 h-4"/>
   123→                LIST
   124→              </button>
   125→           </div>
   126→
   127→           <button className="retro-btn p-3">
   128→             <Search className="w-5 h-5" />
   129→           </button>
   130→           <button
   131→             onClick={() => onOpenTask(null)}
   132→             className="retro-btn bg-cyan-500 text-white px-6 py-3 hover:bg-cyan-600"
   133→           >
   134→             <Plus className="w-5 h-5" />
   135→             <span>NEW_TASK</span>
   136→           </button>
   137→        </div>
   138→      </div>
   139→
   140→      {/* Owner Filter Tabs */}
   141→      <div className="flex items-center justify-center gap-2 shrink-0 flex-wrap">
   142→        {['all', ...people].map((filter) => {
   143→          const isActive = ownerFilter === filter;
   144→          const count = filter === 'all'
   145→            ? tasks.filter(t => !t.isPoc).length
   146→            : filterTasksByOwner(tasks.filter(t => !t.isPoc), filter).length;
   147→
   148→          // 動態配色
   149→          const colors = filter === 'all'
   150→            ? { bg: 'bg-gray-500', hover: 'hover:bg-gray-600' }
   151→            : { bg: 'bg-blue-500', hover: 'hover:bg-blue-600' };
   152→
   153→          return (
   154→            <button
   155→              key={filter}
   156→              onClick={() => setOwnerFilter(filter)}
   157→              className={`retro-btn relative px-5 py-2 text-sm text-white ${colors.bg} ${colors.hover} ${isActive ? 'bg-black' : ''}`}
   158→            >
   159→              {filter.toUpperCase()}
   160→              <span className={`ml-2 px-2 py-0.5 text-xs ${isActive ? 'bg-white text-black' : 'bg-gray-200 text-gray-700'}`}>
   161→                {count}
   162→              </span>
   163→            </button>
   164→          );
   165→        })}
   166→      </div>
   167→
   168→      {/* Dashboard - 參考舊版彩虹甘特圖布局 */}
   169→      <Panel className="shrink-0">
   170→        {isLoading ? (
   171→          <div className="flex items-center justify-center py-12">
   172→            <Loader2 className="w-8 h-8 animate-spin text-gray-500" />
   173→            <span className="ml-3 text-gray-700 font-medium">LOADING_DATA...</span>
   174→          </div>
   175→        ) : (
   176→          <div className="flex flex-col lg:flex-row gap-8">
   177→            {/* 左側：扁平化可愛甜甜圈 -> 數據環 */}
   178→            <div className="flex items-center gap-6 lg:gap-8">
   179→              <div className="relative w-40 h-40 lg:w-48 lg:h-48 shrink-0">
   180→                <svg className="w-full h-full -rotate-90" viewBox="0 0 36 36">
   181→                  {/* Background Circle */}
   182→                  <circle cx="18" cy="18" r="14" fill="none" stroke="#e5e7eb" strokeWidth="6" />
   183→                  
   184→                  {/* Pie Segments */}
   185→                  {pieSegments.map((segment) => (
   186→                    <circle
   187→                      key={segment.category}
   188→                      cx="18"
   189→                      cy="18"
   190→                      r="14"
   191→                      fill="none"
   192→                      stroke={segment.color}
   193→                      strokeWidth="6"
   194→                      strokeDasharray={`${segment.percentage} ${100 - segment.percentage}`}
   195→                      strokeDashoffset={100 - segment.offset}
   196→                      strokeLinecap="butt"
   197→                      className="transition-all duration-500"
   198→                    />
   199→                  ))}
   200→                </svg>
   201→                <div className="absolute inset-0 flex flex-col items-center justify-center">
   202→                  <span className="text-xs text-gray-500 font-bold uppercase tracking-wider">OVERALL_PROGRESS</span>
   203→                  <span className="text-4xl lg:text-5xl font-black text-gray-900">
   204→                    {stats.overallProgress}%
   205→                  </span>
   206→                </div>
   207→              </div>
   208→            </div>
   209→
   210→            {/* 中間：總任務數 + 類別進度條 */}
   211→            <div className="flex-1 space-y-4">
   212→              <div className="flex items-baseline gap-3 mb-6">
   213→                <span className="text-sm text-gray-500 font-bold uppercase tracking-wider">TOTAL_TASKS</span>
   214→                <span className="text-4xl font-black text-gray-900">{stats.total}</span>
   215→              </div>
   216→
   217→              {/* 類別進度條 */}
   218→              <div className="space-y-3">
   219→                {Object.entries(stats.byCategory).map(([category, data]) => {
   220→                  const colors = getColorForCategory(category);
   221→                  const progress = data.total > 0 ? (data.completed / data.total) * 100 : 0;
   222→                  const percentage = stats.total > 0 ? Math.round((data.total / stats.total) * 100) : 0;
   223→
   224→                  return (
   225→                    <div key={category} className="group">
   226→                      <div className="flex items-center gap-3 mb-1.5">
   227→                        <div className={`w-3 h-3 border border-gray-900 ${colors.bar}`} /> {/* Solid block */}
   228→                        <span className={`text-sm font-bold ${colors.text}`}>{category.toUpperCase()}</span>
   229→                        <span className="ml-auto text-sm text-gray-600">
   230→                          {data.total} ({percentage}%)
   231→                        </span>
   232→                      </div>
   233→                      <div className="h-2.5 bg-gray-200 border border-gray-400 overflow-hidden">
   234→                        <div
   235→                          className={`h-full ${colors.bar} transition-all duration-500`}
   236→                          style={{ width: `${progress}%` }}
   237→                        />
   238→                      </div>
   239→                    </div>
   240→                  );
   241→                })}
   242→              </div>
   243→            </div>
   244→
   245→            {/* 右側：任務狀態圖例 */}
   246→            <div className="lg:w-48 shrink-0">
   247→              <div className="retro-panel p-4">
   248→                <p className="text-xs text-gray-500 font-bold uppercase tracking-wider mb-3">TASK_STATUS</p>
   249→                <div className="space-y-2.5">
   250→                  <div className="flex items-center gap-2">
   251→                    <div className="w-3 h-3 bg-emerald-500 border border-gray-900" />
   252→                    <span className="text-sm text-gray-700">COMPLETED</span>
   253→                    <span className="ml-auto text-sm font-bold text-gray-900">{stats.completed}</span>
   254→                  </div>
   255→                  <div className="flex items-center gap-2">
   256→                    <div className="w-3 h-3 bg-blue-500 border border-gray-900" />
   257→                    <span className="text-sm text-gray-700">IN_PROGRESS</span>
   258→                    <span className="ml-auto text-sm font-bold text-gray-900">{stats.inProgress}</span>
   259→                  </div>
   260→                  <div className="flex items-center gap-2">
   261→                    <div className="w-3 h-3 bg-gray-400 border border-gray-900" />
   262→                    <span className="text-sm text-gray-700">PENDING</span>
   263→                    <span className="ml-auto text-sm font-bold text-gray-900">{stats.pending}</span>
   264→                  </div>
   265→                </div>
   266→              </div>
   267→            </div>
   268→          </div>
   269→        )}
   270→      </Panel>
   271→
   272→      {/* Main Content Area */}
   273→      <div className="flex-1 min-h-[500px] flex flex-col relative z-10">
   274→         <div className="flex-1 h-full relative">
   275→            <AnimatePresence mode="wait">
   276→              {viewMode === 'gantt' && (
   277→                <motion.div
   278→                  key="gantt"
   279→                  initial={{ opacity: 0, x: -20 }}
   280→                  animate={{ opacity: 1, x: 0 }}
   281→                  exit={{ opacity: 0, x: 20 }}
   282→                  className="absolute inset-0 pointer-events-auto"
   283→                >
   284→                  <GanttChart tasks={filteredTasks} onTaskClick={onOpenTask} />
   285→                </motion.div>
   286→              )}
   287→              {viewMode === 'list' && (
   288→                <motion.div
   289→                  key="list"
   290→                  initial={{ opacity: 0 }}
   291→                  animate={{ opacity: 1 }}
   292→                  exit={{ opacity: 0 }}
   293→                  className="absolute inset-0 retro-panel p-6 flex items-center justify-center pointer-events-auto"
   294→                >
   295→                  <div className="text-gray-700 font-medium">LIST_VIEW_INIT</div>
   296→                </motion.div>
   297→              )}
   298→            </AnimatePresence>
   299→         </div>
   300→      </div>
   301→    </motion.div>
   302→  );
   303→};
   304→
   305→// POC 狀態配置
   306→const POC_STATUS_CONFIG: Record<string, { label: string; color: string; bgColor: string }> = {
   307→  'pending': { label: 'PENDING', color: 'text-gray-600', bgColor: 'bg-gray-200' },
   308→  'in-progress': { label: 'IN_PROGRESS', color: 'text-blue-600', bgColor: 'bg-blue-200' },
   309→  'completed': { label: 'COMPLETED', color: 'text-emerald-600', bgColor: 'bg-emerald-200' },
   310→  'blocked': { label: 'BLOCKED', color: 'text-red-600', bgColor: 'bg-red-200' },
   311→};
   312→
   313→interface PocViewProps {
   314→  tasks: Task[];
   315→  isLoading: boolean;
   316→  onOpenTask: (task: Task | null) => void;
   317→  onDeleteTask: (taskId: string | number) => void;
   318→}
   319→
   320→const PocView = ({ tasks, isLoading, onOpenTask, onDeleteTask }: PocViewProps) => {
   321→  // 只顯示 POC 任務（isPoc = true）
   322→  const pocTasks = useMemo(() => tasks.filter(t => t.isPoc), [tasks]);
   323→
   324→  const handleNewPoc = () => {
   325→    // 建立新的 POC 提案（不需要日期）
   326→    const newPoc: Partial<Task> = {
   327→      name: '',
   328→      owner: '',
   329→      startDate: '',
   330→      endDate: '',
   331→      status: 'pending',
   332→      category: 'AI賦能',
   333→      progress: 0,
   334→      description: '',
   335→      materials: [],
   336→      isPoc: true,
   337→      stakeholders: [],
   338→    };
   339→    onOpenTask(newPoc as Task);
   340→  };
   341→
   342→  return (
   343→    <motion.div
   344→      initial={{ opacity: 0, y: 20 }}
   345→      animate={{ opacity: 1, y: 0 }}
   346→      exit={{ opacity: 0, y: -20 }}
   347→      className="space-y-6 pb-32 pointer-events-auto"
   348→    >
   349→      {/* Header */}
   350→      <div className="flex items-center justify-between px-2 pr-16">
   351→        <div>
   352→          <h1 className="text-3xl font-bold text-gray-900 tracking-tighter uppercase">DIAGNOSTIC // POC_PROTOCOL</h1>
   353→          <p className="text-gray-600 text-sm mt-1">STATUS: EVALUATION_IN_PROGRESS</p>
   354→        </div>
   355→        <button
   356→          onClick={handleNewPoc}
   357→          className="retro-btn bg-fuchsia-500 text-white px-6 py-3 hover:bg-fuchsia-600"
   358→        >
   359→          <Plus className="w-5 h-5" />
   360→          <span>NEW_PROTOCOL</span>
   361→        </button>
   362→      </div>
   363→
   364→      {/* POC Cards Grid */}
   365→      {isLoading ? (
   366→        <div className="flex items-center justify-center py-20">
   367→          <Loader2 className="w-8 h-8 animate-spin text-gray-500" />
   368→          <span className="ml-3 text-gray-700 font-medium">LOADING_DATA...</span>
   369→        </div>
   370→      ) : pocTasks.length === 0 ? (
   371→        <div className="flex flex-col items-center justify-center py-20 retro-panel">
   372→          <div className="w-20 h-20 bg-gray-200 border-2 border-gray-900 flex items-center justify-center mb-4">
   373→            <FlaskConical className="w-10 h-10 text-gray-700" />
   374→          </div>
   375→          <h3 className="text-xl font-bold text-gray-900 mb-2 uppercase">NO_PROTOCOL_FOUND</h3>
   376→          <p className="text-gray-600 mb-4 text-sm">INITIATE_NEW_PROTOCOL_SEQUENCE_BELOW</p>
   377→          <button
   378→            onClick={handleNewPoc}
   379→            className="retro-btn bg-gray-700 text-white px-4 py-2 hover:bg-gray-900"
   380→          >
   381→            <Plus className="w-4 h-4" />
   382→            INITIATE
   383→          </button>
   384→        </div>
   385→      ) : (
   386→        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
   387→          {pocTasks.map(poc => {
   388→            const statusConfig = POC_STATUS_CONFIG[poc.status] || POC_STATUS_CONFIG['pending'];
   389→            const categoryColor = getColorForCategory(poc.category);
   390→
   391→            return (
   392→              <motion.div
   393→                key={poc.id}
   394→                whileHover={{ y: -4 }}
   395→                onClick={() => onOpenTask(poc)}
   396→                className="retro-panel p-0 overflow-hidden relative group cursor-pointer hover:shadow-lg transition-all"
   397→              >
   398→                {/* Delete Button */}
   399→                <button
   400→                  onClick={(e) => {
   401→                    e.stopPropagation();
   402→                    if (window.confirm('CONFIRM_DELETE_PROTOCOL?')) {
   403→                      onDeleteTask(poc.id);
   404→                    }
   405→                  }}
   406→                  className="retro-btn absolute top-3 right-3 p-1.5 bg-red-500 text-white hover:bg-red-600 z-10"
   407→                  title="DELETE_PROTOCOL"
   408→                >
   409→                  <Trash2 className="w-4 h-4" />
   410→                </button>
   411→
   412→                {/* Card Header */}
   413→                <div className={`h-2 ${categoryColor.bar}`} />
   414→
   415→                <div className="p-5 space-y-4">
   416→                  {/* Status & Category */}
   417→                  <div className="flex items-center gap-2 flex-wrap">
   418→                    <span className={`text-xs font-bold px-2.5 py-1 uppercase ${statusConfig.bgColor} ${statusConfig.color} border border-gray-900`}>
   419→                      {statusConfig.label}
   420→                    </span>
   421→                    <span className={`text-xs font-bold px-2.5 py-1 uppercase ${categoryColor.bg} ${categoryColor.text} border border-gray-900`}>
   422→                      {poc.category}
   423→                    </span>
   424→                  </div>
   425→
   426→                  {/* Title */}
   427→                  <h3 className="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-2 uppercase">
   428→                    {poc.name || 'UNNAMED_PROTOCOL'}
   429→                  </h3>
   430→
   431→                  {/* Description */}
   432→                  {poc.description && (
   433→                    <p className="text-sm text-gray-700 line-clamp-2">
   434→                      {poc.description}
   435→                    </p>
   436→                  )}
   437→
   438→                  {/* Owner */}
   439→                  <div className="flex items-center gap-3 pt-2 border-t border-gray-300">
   440→                    <div className="w-8 h-8 bg-black text-white text-xs font-bold flex items-center justify-center border border-gray-900">
   441→                      {poc.owner ? poc.owner.substring(0, 2).toUpperCase() : '??'}
   442→                    </div>
   443→                    <div className="flex-1 min-w-0">
   444→                      <div className="text-sm font-bold text-gray-900 truncate">
   445→                        {poc.owner || 'UNKNOWN_AGENT'}
   446→                      </div>
   447→                      <div className="text-xs text-gray-600">AGENT</div>
   448→                    </div>
   449→
   450→                    {/* Materials Count */}
   451→                    {poc.materials && poc.materials.length > 0 && (
   452→                      <div className="flex items-center gap-1 text-gray-600">
   453→                        <LinkIcon className="w-4 h-4" />
   454→                        <span className="text-xs font-medium">{poc.materials.length}</span>
   455→                      </div>
   456→                    )}
   457→                  </div>
   458→
   459→                  {/* Stakeholders */}
   460→                  {poc.stakeholders && poc.stakeholders.length > 0 && (
   461→                    <div className="flex items-center gap-2">
   462→                      <span className="text-xs text-gray-600">STAKEHOLDERS:</span>
   463→                      <div className="flex -space-x-2">
   464→                        {poc.stakeholders.slice(0, 3).map((sh, i) => (
   465→                          <div
   466→                            key={sh.id || i}
   467→                            className="w-6 h-6 bg-gray-300 text-gray-800 text-[10px] font-bold flex items-center justify-center border border-gray-900"
   468→                            title={`${sh.name} (${sh.role})`}
   469→                          >
   470→                            {sh.name.substring(0, 1)}
   471→                          </div>
   472→                        ))}
   473→                        {poc.stakeholders.length > 3 && (
   474→                          <div className="w-6 h-6 bg-gray-200 text-gray-700 text-[10px] font-bold flex items-center justify-center border border-gray-900">
   475→                            +{poc.stakeholders.length - 3}
   476→                          </div>
   477→                        )}
   478→                      </div>
   479→                    </div>
   480→                  )}
   481→                </div>
   482→              </motion.div>
   483→            );
   484→          })}
   485→        </div>
   486→      )}
   487→    </motion.div>
   488→  );
   489→};
   490→
   491→// ============ 已完成專案頁面 ============
   492→interface CompletedProjectsViewProps {
   493→  tasks: Task[];
   494→  isLoading: boolean;
   495→  onOpenTask: (task: Task | null) => void;
   496→  onDeleteTask: (taskId: string | number) => void;
   497→  people: string[];
   498→}
   499→
   500→const CompletedProjectsView = ({ tasks, isLoading, onOpenTask, onDeleteTask, people }: CompletedProjectsViewProps) => {
   501→  const [ownerFilter, setOwnerFilter] = useState<string>('all');
   502→
   503→  // 所有已完成的非 POC 任務
   504→  const allCompletedTasks = useMemo(() =>
   505→    tasks.filter(t => !t.isPoc && t.status === 'completed'),
   506→    [tasks]
   507→  );
   508→
   509→  // 根據 owner 篩選並排序
   510→  const completedTasks = useMemo(() =>
   511→    filterTasksByOwner(allCompletedTasks, ownerFilter)
   512→      .sort((a, b) => new Date(b.endDate || 0).getTime() - new Date(a.endDate || 0).getTime()),
   513→    [allCompletedTasks, ownerFilter]
   514→  );
   515→
   516→  const formatDate = (dateStr?: string) => {
   517→    if (!dateStr) return '-';
   518→    const date = new Date(dateStr);
   519→    return `${date.getMonth() + 1}/${date.getDate()}`;
   520→  };
   521→
   522→  const calcDuration = (start?: string, end?: string) => {
   523→    if (!start || !end) return '-';
   524→    const startDate = new Date(start);
   525→    const endDate = new Date(end);
   526→    const diffTime = endDate.getTime() - startDate.getTime();
   527→    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
   528→    return diffDays > 0 ? diffDays : 1;
   529→  };
   530→
   531→  const handleNewCompleted = () => {
   532→    const newTask: Partial<Task> = {
   533→      name: '',
   534→      owner: '',
   535→      startDate: '',
   536→      endDate: '',
   537→      status: 'completed',
   538→      category: 'AI賦能',
   539→      progress: 100,
   540→      description: '',
   541→      materials: [],
   542→      isPoc: false,
   543→    };
   544→    onOpenTask(newTask as Task);
   545→  };
   546→
   547→  return (
   548→    <motion.div
   549→      initial={{ opacity: 0, y: 20 }}
   550→      animate={{ opacity: 1, y: 0 }}
   551→      exit={{ opacity: 0, y: -20 }}
   552→      className="space-y-6 pb-32 pointer-events-auto"
   553→    >
   554→      {/* Header */}
   555→      <div className="flex items-center justify-between px-2 pr-16">
   556→        <div>
   557→          <h1 className="text-3xl font-bold text-gray-900 tracking-tighter uppercase">MISSION_LOG // COMPLETED_PROTOCOLS</h1>
   558→          <p className="text-gray-600 text-sm mt-1">TOTAL_COMPLETED: {completedTasks.length}</p>
   559→        </div>
   560→        <button
   561→          onClick={handleNewCompleted}
   562→          className="retro-btn bg-emerald-500 text-white px-6 py-3 hover:bg-emerald-600"
   563→        >
   564→          <Plus className="w-5 h-5" />
   565→          <span>ADD_ENTRY</span>
   566→        </button>
   567→      </div>
   568→
   569→      {/* Owner Filter Tabs */}
   570→      <div className="flex items-center justify-center gap-2 shrink-0 flex-wrap">
   571→        {['all', ...people].map((filter) => {
   572→          const isActive = ownerFilter === filter;
   573→          const count = filter === 'all'
   574→            ? allCompletedTasks.length
   575→            : allCompletedTasks.filter(t => (t.owner || '').toLowerCase() === filter.toLowerCase()).length;
   576→
   577→          // 動態配色
   578→          const colors = filter === 'all'
   579→            ? { bg: 'bg-gray-500', hover: 'hover:bg-gray-600' }
   580→            : { bg: 'bg-blue-500', hover: 'hover:bg-blue-600' };
   581→
   582→          return (
   583→            <button
   584→              key={filter}
   585→              onClick={() => setOwnerFilter(filter)}
   586→              className={`retro-btn relative px-5 py-2 text-sm text-white ${colors.bg} ${colors.hover} ${isActive ? 'bg-black' : ''}`}
   587→            >
   588→              {filter.toUpperCase()}
   589→              <span className={`ml-2 px-2 py-0.5 text-xs ${isActive ? 'bg-white text-black' : 'bg-gray-200 text-gray-700'}`}>
   590→                {count}
   591→              </span>
   592→            </button>
   593→          );
   594→        })}
   595→      </div>
   596→
   597→      {/* Table */}
   598→      {isLoading ? (
   599→        <div className="flex items-center justify-center py-20">
   600→          <Loader2 className="w-8 h-8 animate-spin text-gray-500" />
   601→          <span className="ml-3 text-gray-700 font-medium">LOADING_DATA...</span>
   602→        </div>
   603→      ) : completedTasks.length === 0 ? (
   604→        <div className="flex flex-col items-center justify-center py-20 retro-panel">
   605→          <div className="w-20 h-20 bg-gray-200 border-2 border-gray-900 flex items-center justify-center mb-4">
   606→            <CheckCircle className="w-10 h-10 text-gray-700" />
   607→          </div>
   608→          <h3 className="text-xl font-bold text-gray-900 mb-2 uppercase">NO_COMPLETED_PROTOCOLS</h3>
   609→          <p className="text-gray-600 text-sm">ARCHIVE_EMPTY. AWAITING_COMPLETION_SIGNAL.</p>
   610→        </div>
   611→      ) : (
   612→        <div className="retro-panel overflow-hidden">
   613→          <table className="w-full">
   614→            <thead>
   615→              <tr className="bg-gray-100 border-b-2 border-gray-900">
   616→                <th className="text-left px-5 py-4 text-sm font-bold text-gray-900 uppercase">PROTOCOL_NAME</th>
   617→                <th className="text-left px-4 py-4 text-sm font-bold text-gray-900 uppercase">AGENT</th>
   618→                <th className="text-left px-4 py-4 text-sm font-bold text-gray-900 uppercase">CATEGORY</th>
   619→                <th className="text-left px-4 py-4 text-sm font-bold text-gray-900 uppercase">START_DATE</th>
   620→                <th className="text-left px-4 py-4 text-sm font-bold text-gray-900 uppercase">END_DATE</th>
   621→                <th className="text-left px-4 py-4 text-sm font-bold text-gray-900 uppercase">DURATION</th>
   622→                <th className="text-center px-4 py-4 text-sm font-bold text-gray-900 uppercase">ACTIONS</th>
   623→              </tr>
   624→            </thead>
   625→            <tbody>
   626→              {completedTasks.map((task, idx) => {
   627→                const categoryColor = getColorForCategory(task.category);
   628→                return (
   629→                  <tr
   630→                    key={task.id}
   631→                    onClick={() => onOpenTask(task)}
   632→                    className={`border-b border-gray-300 hover:bg-gray-100 cursor-pointer transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}
   633→                  >
   634→                    <td className="px-5 py-4">
   635→                      <span className="font-bold text-gray-900 uppercase">{task.name || 'UNNAMED'}</span>
   636→                    </td>
   637→                    <td className="px-4 py-4">
   638→                      <div className="flex items-center gap-2">
   639→                        <div className="w-7 h-7 bg-black text-white text-xs font-bold flex items-center justify-center border border-gray-900">
   640→                          {task.owner ? task.owner.substring(0, 1) : '?'}
   641→                        </div>
   642→                        <span className="text-sm text-gray-800">{task.owner || 'UNKNOWN'}</span>
   643→                      </div>
   644→                    </td>
   645→                    <td className="px-4 py-4">
   646→                      <span className={`text-xs font-bold px-2.5 py-1 uppercase ${categoryColor.bg} ${categoryColor.text} border border-gray-900`}>
   647→                        {task.category || '-'}
   648→                      </span>
   649→                    </td>
   650→                    <td className="px-4 py-4 text-sm text-gray-700">{formatDate(task.startDate)}</td>
   651→                    <td className="px-4 py-4 text-sm text-gray-700">{formatDate(task.endDate)}</td>
   652→                    <td className="px-4 py-4">
   653→                      <span className="text-sm font-medium text-emerald-600">{calcDuration(task.startDate, task.endDate)} DAYS</span>
   654→                    </td>
   655→                    <td className="px-4 py-4 text-center">
   656→                      <button
   657→                        onClick={(e) => {
   658→                          e.stopPropagation();
   659→                          if (window.confirm('CONFIRM_DELETE_ENTRY?')) {
   660→                            onDeleteTask(task.id);
   661→                          }
   662→                        }}
   663→                        className="retro-btn bg-red-500 text-white p-2 hover:bg-red-600"
   664→                        title="DELETE_ENTRY"
   665→                      >
   666→                        <Trash2 className="w-4 h-4" />
   667→                      </button>
   668→                    </td>
   669→                  </tr>
   670→                );
   671→              })}
   672→            </tbody>
   673→          </table>
   674→        </div>
   675→      )}
   676→    </motion.div>
   677→  );
   678→};
   679→
   680→interface LearningViewProps {
   681→  tasks: Task[];
   682→  notes: LearningNote[];
   683→  isLoadingNotes: boolean;
   684→  onAddNote: (note: Omit<LearningNote, 'id' | 'createdAt' | 'updatedAt'>) => Promise<LearningNote>;
   685→  onUpdateNote: (note: LearningNote) => Promise<LearningNote>;
   686→  onDeleteNote: (noteId: string) => Promise<void>;
   687→}
   688→
   689→const LearningView = ({ tasks, notes, isLoadingNotes, onAddNote, onUpdateNote, onDeleteNote }: LearningViewProps) => {
   690→  const [isEditing, setIsEditing] = useState(false);
   691→  const [editingNote, setEditingNote] = useState<Partial<LearningNote> | null>(null);
   692→  const [showProjectSelector, setShowProjectSelector] = useState(false);
   693→
   694→  // 附件管理狀態
   695→  const [newMaterial, setNewMaterial] = useState<{ type: Material['type']; name: string; url: string; note: string; dataUrl: string }>({
   696→    type: 'link',
   697→    name: '',
   698→    url: '',
   699→    note: '',
   700→    dataUrl: ''
   701→  });
   702→
   703→  const handleNewNote = () => {
   704→    setEditingNote({
   705→      title: '',
   706→      content: '',
   707→      relatedTaskIds: [],
   708→      materials: [],
   709→    });
   710→    setIsEditing(true);
   711→  };
   712→
   713→  const handleEditNote = (note: LearningNote) => {
   714→    setEditingNote({ ...note });
   715→    setIsEditing(true);
   716→  };
   717→
   718→  const handleSaveNote = async () => {
   719→    if (!editingNote?.title) {
   720→      alert('請輸入筆記標題');
   721→      return;
   722→    }
   723→
   724→    try {
   725→      if (editingNote.id) {
   726→        // 更新現有筆記
   727→        await onUpdateNote(editingNote as LearningNote);
   728→      } else {
   729→        // 新增筆記
   730→        await onAddNote({
   731→          title: editingNote.title || '',
   732→          content: editingNote.content || '',
   733→          relatedTaskIds: editingNote.relatedTaskIds || [],
   734→          materials: editingNote.materials || [],
   735→        });
   736→      }
   737→
   738→      setIsEditing(false);
   739→      setEditingNote(null);
   740→      setNewMaterial({ type: 'link', name: '', url: '', note: '', dataUrl: '' });
   741→    } catch (err) {
   742→      console.error('Failed to save note:', err);
   743→      alert('儲存失敗，請稍後再試');
   744→    }
   745→  };
   746→
   747→  // 附件管理函數
   748→  const handleAddMaterial = () => {
   749→    if (!newMaterial.name || !editingNote) return;
   750→    const material: Material = {
   751→      id: Date.now().toString(),
   752→      type: newMaterial.type,
   753→      name: newMaterial.name,
   754→      url: newMaterial.url || undefined,
   755→      dataUrl: newMaterial.dataUrl || undefined,
   756→      note: newMaterial.note || undefined,
   757→    };
   758→    setEditingNote({
   759→      ...editingNote,
   760→      materials: [...(editingNote.materials || []), material]
   761→    });
   762→    setNewMaterial({ type: 'link', name: '', url: '', note: '', dataUrl: '' });
   763→  };
   764→
   765→  const handleDeleteMaterial = (materialId: string | number) => {
   766→    if (!editingNote) return;
   767→    setEditingNote({
   768→      ...editingNote,
   769→      materials: (editingNote.materials || []).filter(m => m.id !== materialId)
   770→    });
   771→  };
   772→
   773→  const handleDeleteNote = async (noteId: string) => {
   774→    if (window.confirm('確定要刪除這則筆記嗎？')) {
   775→      try {
   776→        await onDeleteNote(noteId);
   777→      } catch (err) {
   778→        console.error('Failed to delete note:', err);
   779→        alert('刪除失敗，請稍後再試');
   780→      }
   781→    }
   782→  };
   783→
   784→  const handleToggleProject = (taskId: string) => {
   785→    if (!editingNote) return;
   786→    const current = editingNote.relatedTaskIds || [];
   787→    if (current.includes(taskId)) {
   788→      setEditingNote({ ...editingNote, relatedTaskIds: current.filter(id => id !== taskId) });
   789→    } else {
   790→      setEditingNote({ ...editingNote, relatedTaskIds: [...current, taskId] });
   791→    }
   792→  };
   793→
   794→  const getTaskById = (taskId: string) => tasks.find(t => String(t.id) === taskId);
   795→
   796→  // 非 POC 的專案任務
   797→  const projectTasks = useMemo(() => tasks.filter(t => !t.isPoc), [tasks]);
   798→
   799→  return (
   800→    <motion.div
   801→      initial={{ opacity: 0, y: 20 }}
   802→      animate={{ opacity: 1, y: 0 }}
   803→      exit={{ opacity: 0, y: -20 }}
   804→      className="space-y-6 pb-32 pointer-events-auto"
   805→    >
   806→      {/* Header */}
   807→      <div className="flex items-center justify-between px-2 pr-16">
   808→        <div>
   809→          <h1 className="text-3xl font-bold text-gray-900 tracking-tighter uppercase">KNOWLEDGE_BASE // LOG_ENTRIES</h1>
   810→          <p className="text-gray-600 text-sm mt-1">RESEARCH_LOG_STATUS: OPERATIONAL</p>
   811→        </div>
   812→        <button
   813→          onClick={handleNewNote}
   814→          className="retro-btn bg-emerald-500 text-white px-6 py-3 hover:bg-emerald-600"
   815→        >
   816→          <Plus className="w-5 h-5" />
   817→          <span>NEW_ENTRY</span>
   818→        </button>
   819→      </div>
   820→
   821→      {/* Notes List or Empty State */}
   822→      {isLoadingNotes ? (
   823→        <div className="flex items-center justify-center py-20">
   824→          <Loader2 className="w-8 h-8 animate-spin text-gray-500" />
   825→          <span className="ml-3 text-gray-700 font-medium">LOADING_DATA...</span>
   826→        </div>
   827→      ) : notes.length === 0 && !isEditing ? (
   828→        <div className="flex flex-col items-center justify-center py-20 retro-panel">
   829→          <div className="w-20 h-20 bg-gray-200 border-2 border-gray-900 flex items-center justify-center mb-4">
   830→            <BookOpen className="w-10 h-10 text-gray-700" />
   831→          </div>
   832→          <h3 className="text-xl font-bold text-gray-900 mb-2 uppercase">NO_LOG_ENTRIES</h3>
   833→          <p className="text-gray-600 mb-4 text-sm text-center">CREATE_FIRST_LOG_ENTRY_BELOW</p>
   834→          <button
   835→            onClick={handleNewNote}
   836→            className="retro-btn bg-gray-700 text-white px-4 py-2 hover:bg-gray-900"
   837→          >
   838→            <Plus className="w-4 h-4" />
   839→            CREATE_ENTRY
   840→          </button>
   841→        </div>
   842→      ) : (
   843→        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
   844→          {/* Notes Panels */}
   845→          {notes.map(note => (
   846→            <motion.div
   847→              key={note.id}
   848→              whileHover={{ y: -2 }}
   849→              className="retro-panel overflow-hidden group"
   850→            >
   851→              <div className="p-5 space-y-3">
   852→                {/* Title & Actions */}
   853→                <div className="flex items-start justify-between gap-3">
   854→                  <h3 className="text-lg font-bold text-gray-900 flex-1 uppercase">{note.title}</h3>
   855→                  <div className="flex gap-1 shrink-0">
   856→                    <button
   857→                      onClick={() => handleEditNote(note)}
   858→                      className="retro-btn p-1.5 text-gray-700 hover:text-blue-600 hover:bg-blue-100"
   859→                    >
   860→                      <FileText className="w-4 h-4" />
   861→                    </button>
   862→                    <button
   863→                      onClick={() => handleDeleteNote(note.id)}
   864→                      className="retro-btn p-1.5 text-gray-700 hover:text-red-600 hover:bg-red-100"
   865→                    >
   866→                      <Trash2 className="w-4 h-4" />
   867→                    </button>
   868→                  </div>
   869→                </div>
   870→
   871→                {/* Content Preview */}
   872→                {note.content && (
   873→                  <p className="text-sm text-gray-700 line-clamp-3 whitespace-pre-wrap">
   874→                    {note.content}
   875→                  </p>
   876→                )}
   877→
   878→                {/* Related Protocols */}
   879→                {note.relatedTaskIds.length > 0 && (
   880→                  <div className="flex flex-wrap gap-2 pt-2 border-t border-gray-300">
   881→                    <span className="text-xs text-gray-600 font-medium uppercase">RELATED_PROTOCOLS:</span>
   882→                    {note.relatedTaskIds.map(taskId => {
   883→                      const task = getTaskById(taskId);
   884→                      if (!task) return null;
   885→                      const colors = getColorForCategory(task.category);
   886→                      return (
   887→                        <span
   888→                          key={taskId}
   889→                          className={`text-xs font-bold px-2 py-0.5 uppercase ${colors.bg} ${colors.text} border border-gray-900`}
   890→                        >
   891→                          {task.name}
   892→                        </span>
   893→                      );
   894→                    })}
   895→                  </div>
   896→                )}
   897→
   898→                {/* Attachments Display */}
   899→                {note.materials && note.materials.length > 0 && (
   900→                  <div className="space-y-2 pt-2 border-t border-gray-300">
   901→                    <span className="text-xs text-gray-600 font-medium flex items-center gap-1 uppercase">
   902→                      <LinkIcon className="w-3 h-3" />ATTACHMENTS ({note.materials.length})
   903→                    </span>
   904→                    <div className="space-y-2">
   905→                      {note.materials.map(material => (
   906→                        <div key={material.id} className="flex items-center gap-2 p-2 retro-panel-inner">
   907→                          <div className={`w-6 h-6 border border-gray-900 flex items-center justify-center text-xs shrink-0
   908→                            ${material.type === 'link' ? 'bg-blue-500 text-white' :
   909→                              material.type === 'image' ? 'bg-emerald-500 text-white' :
   910→                              material.type === 'video' ? 'bg-red-500 text-white' :
   911→                              material.type === 'note' ? 'bg-amber-500 text-white' : 'bg-gray-500 text-white'}`}
   912→                          >
   913→                            {material.type === 'link' ? <LinkIcon className="w-3 h-3" /> :
   914→                             material.type === 'image' ? <ImageIcon className="w-3 h-3" /> :
   915→                             material.type === 'video' ? <PlayCircle className="w-3 h-3" /> :
   916→                             <FileText className="w-3 h-3" />}
   917→                          </div>
   918→                          <span className="text-xs font-medium text-gray-800 flex-1 truncate">{material.name}</span>
   919→                          {material.type === 'image' && material.dataUrl && (
   920→                            <img src={material.dataUrl} alt={material.name} className="w-8 h-8 object-cover border border-gray-900" />
   921→                          )}
   922→                          {material.url && (
   923→                            <a
   924→                              href={material.url}
   925→                              target="_blank"
   926→                              rel="noopener noreferrer"
   927→                              className="text-xs text-blue-600 hover:underline"
   928→                              onClick={(e) => e.stopPropagation()}
   929→                            >
   930→                              OPEN
   931→                            </a>
   932→                          )}
   933→                        </div>
   934→                      ))}
   935→                    </div>
   936→                  </div>
   937→                )}
   938→
   939→                {/* Meta */}
   940→                <div className="text-xs text-gray-600 pt-2 uppercase">
   941→                  LAST_MODIFIED: {new Date(note.updatedAt).toLocaleDateString('zh-TW')}
   942→                </div>
   943→              </div>
   944→            </motion.div>
   945→          ))}
   946→        </div>
   947→      )}
   948→
   949→      {/* Note Editor Modal */}
   950→      <AnimatePresence>
   951→        {isEditing && editingNote && (
   952→          <motion.div
   953→            initial={{ opacity: 0 }}
   954→            animate={{ opacity: 1 }}
   955→            exit={{ opacity: 0 }}
   956→            className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[80] flex items-center justify-center p-4"
   957→            onClick={() => { setIsEditing(false); setEditingNote(null); }}
   958→          >
   959→            <motion.div
   960→              initial={{ scale: 0.95, opacity: 0 }}
   961→              animate={{ scale: 1, opacity: 1 }}
   962→              exit={{ scale: 0.95, opacity: 0 }}
   963→              onClick={(e) => e.stopPropagation()}
   964→              className="retro-panel w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col"
   965→            >
   966→              {/* Editor Header */}
   967→              <div className="p-5 border-b-2 border-gray-900 flex items-center justify-between bg-gray-100">
   968→                <h3 className="text-lg font-bold text-gray-900 uppercase">
   969→                  {editingNote.id ? 'EDIT_LOG_ENTRY' : 'NEW_LOG_ENTRY'}
   970→                </h3>
   971→                <button
   972→                  onClick={() => { setIsEditing(false); setEditingNote(null); }}
   973→                  className="retro-btn p-2 text-gray-700 hover:bg-gray-200"
   974→                >
   975→                  <X className="w-5 h-5" />
   976→                </button>
   977→              </div>
   978→
   979→              {/* Editor Content */}
   980→              <div className="flex-1 overflow-y-auto p-5 space-y-5">
   981→                {/* Title */}
   982→                <div>
   983→                  <label className="text-xs font-bold text-gray-600 uppercase tracking-wider mb-2 block">
   984→                    TITLE
   985→                  </label>
   986→                  <input
   987→                    type="text"
   988→                    value={editingNote.title || ''}
   989→                    onChange={(e) => setEditingNote({ ...editingNote, title: e.target.value })}
   990→                    placeholder="ENTER_TITLE..."
   991→                    className="w-full px-4 py-3 border-2 border-gray-400 bg-white text-lg font-bold focus:outline-none focus:border-cyan-500 uppercase"
   992→                  />
   993→                </div>
   994→
   995→                {/* Related Protocols Selector */}
   996→                <div>
   997→                  <label className="text-xs font-bold text-gray-600 uppercase tracking-wider mb-2 block">
   998→                    RELATED_PROTOCOLS (REF)
   999→                  </label>
  1000→                  <div className="relative">
  1001→                    <button
  1002→                      onClick={() => setShowProjectSelector(!showProjectSelector)}
  1003→                      className="retro-btn w-full px-4 py-3 text-left flex items-center justify-between hover:border-gray-600"
  1004→                    >
  1005→                      <span className="text-gray-800 uppercase">
  1006→                        {(editingNote.relatedTaskIds?.length || 0) > 0
  1007→                          ? `SELECTED: ${editingNote.relatedTaskIds?.length}`
  1008→                          : 'SELECT_RELATED_PROTOCOL...'}
  1009→                      </span>
  1010→                      <ChevronDown className={`w-5 h-5 text-gray-600 transition-transform ${showProjectSelector ? 'rotate-180' : ''}`} />
  1011→                    </button>
  1012→
  1013→                    {/* Protocol Dropdown */}
  1014→                    <AnimatePresence>
  1015→                      {showProjectSelector && (
  1016→                        <>
  1017→                          {/* Overlay to close on outside click */}
  1018→                          <div
  1019→                            className="fixed inset-0 z-[5]"
  1020→                            onClick={() => setShowProjectSelector(false)}
  1021→                          />
  1022→                          <motion.div
  1023→                            initial={{ opacity: 0, y: -10 }}
  1024→                            animate={{ opacity: 1, y: 0 }}
  1025→                            exit={{ opacity: 0, y: -10 }}
  1026→                            className="absolute top-full left-0 right-0 mt-2 retro-panel overflow-hidden z-10 max-h-60"
  1027→                          >
  1028→                          {projectTasks.length === 0 ? (
  1029→                            <div className="p-4 text-center text-gray-600 text-sm">
  1030→                              NO_PROTOCOLS_AVAILABLE
  1031→                            </div>
  1032→                          ) : (
  1033→                            projectTasks.map(task => {
  1034→                              const isSelected = editingNote.relatedTaskIds?.includes(String(task.id));
  1035→                              const colors = getColorForCategory(task.category);
  1036→                              return (
  1037→                                <button
  1038→                                  key={task.id}
  1039→                                  onClick={() => handleToggleProject(String(task.id))}
  1040→                                  className={`w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-100 transition-colors ${isSelected ? 'bg-emerald-100' : ''}`}
  1041→                                >
  1042→                                  <div className={`w-5 h-5 border-2 border-gray-900 flex items-center justify-center ${isSelected ? 'bg-emerald-500' : 'bg-gray-300'}`}>
  1043→                                    {isSelected && <Check className="w-3 h-3 text-white" />}
  1044→                                  </div>
  1045→                                  <span className={`text-xs font-bold px-2 py-0.5 uppercase ${colors.bg} ${colors.text} border border-gray-900`}>
  1046→                                    {task.category}
  1047→                                  </span>
  1048→                                  <span className="text-sm font-medium text-gray-900 flex-1 text-left uppercase">
  1049→                                    {task.name}
  1050→                                  </span>
  1051→                                </button>
  1052→                              );
  1053→                            })
  1054→                          )}
  1055→                          </motion.div>
  1056→                        </>
  1057→                      )}
  1058→                    </AnimatePresence>
  1059→                  </div>
  1060→
  1061→                  {/* Selected Protocols Tags */}
  1062→                  {(editingNote.relatedTaskIds?.length || 0) > 0 && (
  1063→                    <div className="flex flex-wrap gap-2 mt-2">
  1064→                      {editingNote.relatedTaskIds?.map(taskId => {
  1065→                        const task = getTaskById(taskId);
  1066→                        if (!task) return null;
  1067→                        return (
  1068→                          <span
  1069→                            key={taskId}
  1070→                            className="inline-flex items-center gap-1 text-xs font-bold px-2.5 py-1 uppercase bg-emerald-200 text-emerald-800 border border-gray-900"
  1071→                          >
  1072→                            {task.name}
  1073→                            <button
  1074→                              onClick={() => handleToggleProject(taskId)}
  1075→                              className="retro-btn p-0.5 bg-emerald-300 hover:bg-emerald-400"
  1076→                            >
  1077→                              <X className="w-3 h-3" />
  1078→                            </button>
  1079→                          </span>
  1080→                        );
  1081→                      })}
  1082→                    </div>
  1083→                  )}
  1084→                </div>
  1085→
  1086→                {/* Content */}
  1087→                <div>
  1088→                  <label className="text-xs font-bold text-gray-600 uppercase tracking-wider mb-2 block">
  1089→                    CONTENT
  1090→                  </label>
  1091→                  <textarea
  1092→                    value={editingNote.content || ''}
  1093→                    onChange={(e) => setEditingNote({ ...editingNote, content: e.target.value })}
  1094→                    rows={6}
  1095→                    placeholder="RECORD_OBSERVATIONS_HERE..."
  1096→                    className="w-full px-4 py-3 border-2 border-gray-400 bg-white text-sm focus:outline-none focus:border-cyan-500 resize-none"
  1097→                  />
  1098→                </div>
  1099→
  1100→                {/* Attachments */}
  1101→                <div>
  1102→                  <label className="text-xs font-bold text-gray-600 uppercase tracking-wider mb-2 block">
  1103→                    <LinkIcon className="w-3 h-3 inline mr-1" />ATTACHMENTS
  1104→                  </label>
  1105→
  1106→                  {/* Existing Attachments List */}
  1107→                  <div className="space-y-2 mb-3">
  1108→                    {(editingNote.materials || []).map(material => (
  1109→                      <div key={material.id} className="flex items-center gap-3 p-3 retro-panel-inner group hover:border-blue-600 transition-colors">
  1110→                        <div className={`w-8 h-8 border border-gray-900 flex items-center justify-center text-xs shrink-0
  1111→                          ${material.type === 'link' ? 'bg-blue-500 text-white' :
  1112→                            material.type === 'image' ? 'bg-emerald-500 text-white' :
  1113→                            material.type === 'video' ? 'bg-red-500 text-white' :
  1114→                            material.type === 'note' ? 'bg-amber-500 text-white' : 'bg-gray-500 text-white'}`}
  1115→                        >
  1116→                          {material.type === 'link' ? <LinkIcon className="w-4 h-4" /> :
  1117→                           material.type === 'image' ? <ImageIcon className="w-4 h-4" /> :
  1118→                           material.type === 'video' ? <PlayCircle className="w-4 h-4" /> :
  1119→                           <FileText className="w-4 h-4" />}
  1120→                        </div>
  1121→                        <div className="flex-1 min-w-0">
  1122→                          <div className="text-sm font-bold text-gray-900 truncate">{material.name}</div>
  1123→                          {material.url && <div className="text-xs text-gray-600 truncate">{material.url}</div>}
  1124→                        </div>
  1125→                        {material.type === 'image' && material.dataUrl && (
  1126→                          <img src={material.dataUrl} alt={material.name} className="w-10 h-10 object-cover border border-gray-900" />
  1127→                        )}
  1128→                        <button
  1129→                          onClick={() => handleDeleteMaterial(material.id)}
  1130→                          className="retro-btn p-1.5 text-gray-700 hover:text-red-600 hover:bg-red-100 opacity-0 group-hover:opacity-100 transition-all"
  1131→                        >
  1132→                          <Trash2 className="w-4 h-4" />
  1133→                        </button>
  1134→                      </div>
  1135→                    ))}
  1136→                  </div>
  1137→
  1138→                  {/* Add New Attachment Form */}
  1139→                  <div className="space-y-3 p-3 bg-gray-100 border-2 border-dashed border-gray-400">
  1140→                    {/* Type Selection */}
  1141→                    <div className="flex flex-wrap gap-2">
  1142→                      {[
  1143→                        { type: 'link', label: '連結', icon: LinkIcon, color: 'bg-blue-500' },
  1144→                        { type: 'image', label: '圖片', icon: ImageIcon, color: 'bg-green-500' },
  1145→                        { type: 'file', label: '檔案', icon: FileText, color: 'bg-orange-500' },
  1146→                        { type: 'note', label: '筆記', icon: FileText, color: 'bg-yellow-500' },
  1147→                        { type: 'video', label: '影片', icon: PlayCircle, color: 'bg-red-500' },
  1148→                      ].map(item => (
  1149→                        <button
  1150→                          key={item.type}
  1151→                          onClick={() => setNewMaterial(prev => ({ ...prev, type: item.type as Material['type'] }))}
  1152→                          className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold transition-all ${
  1153→                            newMaterial.type === item.type
  1154→                              ? `${item.color} text-white shadow-md`
  1155→                              : 'bg-white border border-slate-200 text-slate-600 hover:border-slate-300'
  1156→                          }`}
  1157→                        >
  1158→                          <item.icon className="w-3 h-3" />
  1159→                          {item.label}
  1160→                        </button>
  1161→                      ))}
  1162→                    </div>
  1163→
  1164→                    {/* 名稱輸入 */}
  1165→                    <input
  1166→                      type="text"
  1167→                      placeholder="附件名稱"
  1168→                      value={newMaterial.name}
  1169→                      onChange={(e) => setNewMaterial(prev => ({ ...prev, name: e.target.value }))}
  1170→                      className="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-emerald-300 outline-none"
  1171→                    />
  1172→
  1173→                    {/* 根據類型顯示不同輸入 */}
  1174→                    {newMaterial.type === 'note' ? (
  1175→                      <textarea
  1176→                        placeholder="筆記內容..."
  1177→                        value={newMaterial.note || ''}
  1178→                        onChange={(e) => setNewMaterial(prev => ({ ...prev, note: e.target.value }))}
  1179→                        rows={2}
  1180→                        className="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-emerald-300 outline-none resize-none"
  1181→                      />
  1182→                    ) : newMaterial.type === 'image' ? (
  1183→                      <div className="space-y-2">
  1184→                        <input
  1185→                          type="text"
  1186→                          placeholder="圖片網址 (或上傳圖片)"
  1187→                          value={newMaterial.url}
  1188→                          onChange={(e) => setNewMaterial(prev => ({ ...prev, url: e.target.value, dataUrl: '' }))}
  1189→                          className="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-emerald-300 outline-none"
  1190→                        />
  1191→                        <label className="flex items-center justify-center gap-2 w-full py-2 bg-green-50 border-2 border-dashed border-green-300 text-green-600 rounded-lg text-xs font-medium cursor-pointer hover:bg-green-100 transition-colors">
  1192→                          <Upload className="w-4 h-4" />
  1193→                          上傳圖片
  1194→                          <input
  1195→                            type="file"
  1196→                            className="hidden"
  1197→                            accept="image/*"
  1198→                            onChange={(e) => {
  1199→                              const file = e.target.files?.[0];
  1200→                              if (!file) return;
  1201→                              if (file.size > 5 * 1024 * 1024) {
  1202→                                alert('檔案大小不能超過 5MB');
  1203→                                return;
  1204→                              }
  1205→                              const reader = new FileReader();
  1206→                              reader.onload = () => {
  1207→                                setNewMaterial(prev => ({
  1208→                                  ...prev,
  1209→                                  name: prev.name || file.name,
  1210→                                  dataUrl: reader.result as string,
  1211→                                  url: ''
  1212→                                }));
  1213→                              };
  1214→                              reader.readAsDataURL(file);
  1215→                              e.target.value = '';
  1216→                            }}
  1217→                          />
  1218→                        </label>
  1219→                        {newMaterial.dataUrl && (
  1220→                          <div className="relative">
  1221→                            <img src={newMaterial.dataUrl} alt="預覽" className="w-full h-24 object-cover rounded-lg" />
  1222→                            <button
  1223→                              onClick={() => setNewMaterial(prev => ({ ...prev, dataUrl: '' }))}
  1224→                              className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
  1225→                            >
  1226→                              <X className="w-3 h-3" />
  1227→                            </button>
  1228→                          </div>
  1229→                        )}
  1230→                      </div>
  1231→                    ) : newMaterial.type === 'file' ? (
  1232→                      <label className="flex items-center justify-center gap-2 w-full py-2 bg-orange-50 border-2 border-dashed border-orange-300 text-orange-600 rounded-lg text-xs font-medium cursor-pointer hover:bg-orange-100 transition-colors">
  1233→                        <Upload className="w-4 h-4" />
  1234→                        上傳檔案
  1235→                        <input
  1236→                          type="file"
  1237→                          className="hidden"
  1238→                          accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
  1239→                          onChange={(e) => {
  1240→                            const file = e.target.files?.[0];
  1241→                            if (!file) return;
  1242→                            if (file.size > 5 * 1024 * 1024) {
  1243→                              alert('檔案大小不能超過 5MB');
  1244→                              return;
  1245→                            }
  1246→                            const reader = new FileReader();
  1247→                            reader.onload = () => {
  1248→                              setNewMaterial(prev => ({
  1249→                                ...prev,
  1250→                                name: prev.name || file.name,
  1251→                                dataUrl: reader.result as string
  1252→                              }));
  1253→                            };
  1254→                            reader.readAsDataURL(file);
  1255→                            e.target.value = '';
  1256→                          }}
  1257→                        />
  1258→                      </label>
  1259→                    ) : (
  1260→                      <input
  1261→                        type="text"
  1262→                        placeholder={newMaterial.type === 'video' ? '影片網址' : '連結網址'}
  1263→                        value={newMaterial.url}
  1264→                        onChange={(e) => setNewMaterial(prev => ({ ...prev, url: e.target.value }))}
  1265→                        className="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-emerald-300 outline-none"
  1266→                      />
  1267→                    )}
  1268→
  1269→                    {/* 新增按鈕 */}
  1270→                    <button
  1271→                      onClick={handleAddMaterial}
  1272→                      disabled={
  1273→                        !newMaterial.name ||
  1274→                        (newMaterial.type === 'link' && !newMaterial.url) ||
  1275→                        (newMaterial.type === 'video' && !newMaterial.url) ||
  1276→                        (newMaterial.type === 'image' && !newMaterial.url && !newMaterial.dataUrl) ||
  1277→                        (newMaterial.type === 'file' && !newMaterial.dataUrl)
  1278→                      }
  1279→                      className="w-full py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg text-sm font-bold hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
  1280→                    >
  1281→                      <Plus className="w-4 h-4" />
  1282→                      新增附件
  1283→                    </button>
  1284→                  </div>
  1285→                </div>
  1286→              </div>
  1287→
  1288→              {/* Editor Footer */}
  1289→              <div className="p-5 border-t-2 border-gray-900 flex gap-3 bg-gray-100">
  1290→                <button
  1291→                  onClick={handleSaveNote}
  1292→                  className="retro-btn flex-1 py-3 bg-blue-500 text-white hover:bg-blue-600"
  1293→                >
  1294→                  <Save className="w-5 h-5" />
  1295→                  SAVE_ENTRY
  1296→                </button>
  1297→                <button
  1298→                  onClick={() => { setIsEditing(false); setEditingNote(null); }}
  1299→                  className="retro-btn px-6 py-3 bg-gray-300 text-gray-800 hover:bg-gray-400"
  1300→                >
  1301→                  CANCEL
  1302→                </button>
  1303→              </div>
  1304→            </motion.div>
  1305→          </motion.div>
  1306→        )}
  1307→      </AnimatePresence>
  1308→    </motion.div>
  1309→  );
  1310→};
  1311→
  1312→type ViewType = 'active' | 'completed' | 'poc' | 'learning' | 'calendar';
  1313→
  1314→const AppV2 = () => {
  1315→  const [activeView, setActiveView] = useState<ViewType>('active');
  1316→  const [selectedTask, setSelectedTask] = useState<Task | null>(null);
  1317→  const [isPanelOpen, setIsPanelOpen] = useState(false);
  1318→  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  1319→
  1320→  // 人員管理狀態
  1321→  const [people, setPeople] = useState<string[]>(() => {
  1322→    const saved = localStorage.getItem('gantt-v2:people');
  1323→    return saved ? JSON.parse(saved) : ['Ja', 'Jo'];
  1324→  });
  1325→  const [newPersonName, setNewPersonName] = useState('');
  1326→  const [editingPerson, setEditingPerson] = useState<string | null>(null);
  1327→  const [editingName, setEditingName] = useState('');
  1328→
  1329→  // 連接真實後端數據
  1330→  const { tasks, isLoading, error, saveTasks, refetch } = useTasks();
  1331→  const { notes, isLoading: isLoadingNotes, addNote, updateNote, deleteNote } = useNotes();
  1332→
  1333→  // 人員管理函數
  1334→  const handleAddPerson = () => {
  1335→    const trimmed = newPersonName.trim();
  1336→    if (!trimmed || people.includes(trimmed)) return;
  1337→
  1338→    const updated = [...people, trimmed];
  1339→    setPeople(updated);
  1340→    localStorage.setItem('gantt-v2:people', JSON.stringify(updated));
  1341→    setNewPersonName('');
  1342→  };
  1343→
  1344→  const handleDeletePerson = (name: string) => {
  1345→    const updated = people.filter(p => p !== name);
  1346→    setPeople(updated);
  1347→    localStorage.setItem('gantt-v2:people', JSON.stringify(updated));
  1348→  };
  1349→
  1350→  const handleStartEdit = (person: string) => {
  1351→    setEditingPerson(person);
  1352→    setEditingName(person);
  1353→  };
  1354→
  1355→  const handleSaveEdit = async (oldName: string) => {
  1356→    const trimmed = editingName.trim();
  1357→
  1358→    // 驗證：不能為空，不能與現有名稱重複（除了自己）
  1359→    if (!trimmed || (trimmed !== oldName && people.includes(trimmed))) {
  1360→      setEditingPerson(null);
  1361→      return;
  1362→    }
  1363→
  1364→    // 如果名稱沒有變化，直接取消編輯
  1365→    if (trimmed === oldName) {
  1366→      setEditingPerson(null);
  1367→      return;
  1368→    }
  1369→
  1370→    // 更新 people 列表
  1371→    const updatedPeople = people.map(p => p === oldName ? trimmed : p);
  1372→    setPeople(updatedPeople);
  1373→    localStorage.setItem('gantt-v2:people', JSON.stringify(updatedPeople));
  1374→
  1375→    // 更新所有相關任務的 owner
  1376→    const updatedTasks = tasks.map(task => {
  1377→      if (task.owner === oldName) {
  1378→        return { ...task, owner: trimmed };
  1379→      }
  1380→      return task;
  1381→    });
  1382→
  1383→    // 保存到後端
  1384→    await saveTasks(updatedTasks);
  1385→
  1386→    setEditingPerson(null);
  1387→  };
  1388→
  1389→  const handleCancelEdit = () => {
  1390→    setEditingPerson(null);
  1391→    setEditingName('');
  1392→  };
  1393→
  1394→  const handleOpenTask = (task: Task | null) => {
  1395→    setSelectedTask(task);
  1396→    setIsPanelOpen(true);
  1397→  };
  1398→
  1399→  const handleClosePanel = () => {
  1400→    setIsPanelOpen(false);
  1401→    setSelectedTask(null);
  1402→  };
  1403→
  1404→  const handleSaveTask = async (updatedTask: Task) => {
  1405→    const existingIndex = tasks.findIndex(t => t.id === updatedTask.id);
  1406→    let newTasks: Task[];
  1407→
  1408→    if (existingIndex >= 0) {
  1409→      // 更新現有任務
  1410→      newTasks = tasks.map(t => t.id === updatedTask.id ? updatedTask : t);
  1411→    } else {
  1412→      // 新增任務
  1413→      newTasks = [...tasks, { ...updatedTask, id: Date.now().toString() }];
  1414→    }
  1415→
  1416→    await saveTasks(newTasks);
  1417→    setSelectedTask(null);
  1418→    setIsPanelOpen(false);
  1419→  };
  1420→
  1421→  const handleDeleteTask = async (taskId: string | number) => {
  1422→    const newTasks = tasks.filter(t => t.id !== taskId);
  1423→    await saveTasks(newTasks);
  1424→  };
  1425→
  1426→  return (
  1427→    <div className="retro-light-bg min-h-screen font-jetbrains-mono selection:bg-blue-200 selection:text-blue-900 overflow-hidden relative">
  1428→      <div className="w-full h-full overflow-y-auto custom-scrollbar p-2 md:p-6 relative z-0">
  1429→        <AnimatePresence mode="wait">
  1430→          {activeView === 'active' && (
  1431→            <DeliveryView
  1432→              key="active"
  1433→              tasks={tasks.filter(t => !t.isPoc)}
  1434→              isLoading={isLoading}
  1435→              onOpenTask={handleOpenTask}
  1436→              people={people}
  1437→            />
  1438→          )}
  1439→          {activeView === 'completed' && (
  1440→            <CompletedProjectsView
  1441→              key="completed"
  1442→              tasks={tasks}
  1443→              isLoading={isLoading}
  1444→              onOpenTask={handleOpenTask}
  1445→              onDeleteTask={handleDeleteTask}
  1446→              people={people}
  1447→            />
  1448→          )}
  1449→          {activeView === 'poc' && (
  1450→            <PocView
  1451→              key="poc"
  1452→              tasks={tasks}
  1453→              isLoading={isLoading}
  1454→              onOpenTask={handleOpenTask}
  1455→              onDeleteTask={handleDeleteTask}
  1456→            />
  1457→          )}
  1458→          {activeView === 'learning' && (
  1459→            <LearningView
  1460→              key="learning"
  1461→              tasks={tasks}
  1462→              notes={notes}
  1463→              isLoadingNotes={isLoadingNotes}
  1464→              onAddNote={addNote}
  1465→              onUpdateNote={updateNote}
  1466→              onDeleteNote={deleteNote}
  1467→            />
  1468→          )}
  1469→          {activeView === 'calendar' && (
  1470→            <motion.div
  1471→              key="calendar"
  1472→              initial={{ opacity: 0, y: 20 }}
  1473→              animate={{ opacity: 1, y: 0 }}
  1474→              exit={{ opacity: 0, y: -20 }}
  1475→              className="pb-24 h-full flex flex-col pointer-events-auto"
  1476→            >
  1477→              {/* Compact Header */}
  1478→              <div className="flex items-center justify-between px-2 pr-16 mb-3 shrink-0">
  1479→                <div>
  1480→                  <h1 className="text-2xl font-bold text-gray-900 tracking-tighter uppercase">TIMELINE // CALENDAR_VIEW</h1>
  1481→                  <p className="text-gray-600 text-xs mt-0.5">DUAL_CALENDAR_SYNC_STATUS: OPERATIONAL</p>
  1482→                </div>
  1483→              </div>
  1484→
  1485→              {/* Calendar Component - Full Screen */}
  1486→              <div className="flex-1 min-h-0 overflow-hidden">
  1487→                <CalendarView />
  1488→              </div>
  1489→            </motion.div>
  1490→          )}
  1491→        </AnimatePresence>
  1492→      </div>
  1493→
  1494→      <NavigationIsland activeView={activeView} onChangeView={setActiveView} />
  1495→
  1496→      {/* 設定按鈕 - Fixed 右上角 */}
  1497→      {!isSettingsOpen && (
  1498→        <button
  1499→          onClick={() => setIsSettingsOpen(true)}
  1500→          className="retro-btn fixed top-6 right-12 z-50 p-3 bg-white text-gray-800 hover:bg-gray-100"
  1501→        >
  1502→          <Settings className="w-6 h-6" />
  1503→        </button>
  1504→      )}
  1505→
  1506→      {/* 設定面板 */}
  1507→      <AnimatePresence>
  1508→        {isSettingsOpen && (
  1509→          <>
  1510→            <motion.div
  1511→              initial={{ opacity: 0 }}
  1512→              animate={{ opacity: 1 }}
  1513→              exit={{ opacity: 0 }}
  1514→              onClick={() => setIsSettingsOpen(false)}
  1515→              className="fixed inset-0 bg-black/50 z-60"
  1516→            />
  1517→            <motion.div
  1518→              initial={{ x: '100%' }}
  1519→              animate={{ x: 0 }}
  1520→              exit={{ x: '100%' }}
  1521→              transition={{ type: 'spring', damping: 25, stiffness: 200 }}
  1522→              className="retro-panel fixed top-0 right-0 bottom-0 w-full md:w-96 z-70 flex flex-col"
  1523→            >
  1524→              {/* Header */}
  1525→              <div className="p-4 border-b-2 border-gray-900 bg-gray-100 flex items-center justify-between">
  1526→                <h2 className="text-xl font-bold text-gray-900 uppercase">SETTINGS</h2>
  1527→                <button
  1528→                  onClick={() => setIsSettingsOpen(false)}
  1529→                  className="retro-btn p-2 text-gray-700 hover:bg-gray-200"
  1530→                >
  1531→                  <X className="w-5 h-5" />
  1532→                </button>
  1533→              </div>
  1534→
  1535→              {/* Content */}
  1536→              <div className="flex-1 overflow-y-auto p-4 space-y-6">
  1537→                {/* 人員管理 */}
  1538→                <div>
  1539→                  <h3 className="text-sm font-bold text-gray-600 uppercase mb-3">PEOPLE_MANAGEMENT</h3>
  1540→
  1541→                  {/* 人員列表 */}
  1542→                  <div className="space-y-2 mb-3">
  1543→                    {people.map(person => (
  1544→                      <div key={person} className="retro-panel-inner flex items-center justify-between p-2 gap-2">
  1545→                        {editingPerson === person ? (
  1546→                          // 編輯模式
  1547→                          <>
  1548→                            <input
  1549→                              type="text"
  1550→                              value={editingName}
  1551→                              onChange={(e) => setEditingName(e.target.value)}
  1552→                              onKeyDown={(e) => {
  1553→                                if (e.key === 'Enter') handleSaveEdit(person);
  1554→                                if (e.key === 'Escape') handleCancelEdit();
  1555→                              }}
  1556→                              onBlur={() => handleSaveEdit(person)}
  1557→                              autoFocus
  1558→                              className="flex-1 px-2 py-1 border-2 border-blue-500 bg-white text-sm font-bold text-gray-900 uppercase focus:outline-none"
  1559→                            />
  1560→                            <button
  1561→                              onClick={() => handleSaveEdit(person)}
  1562→                              className="retro-btn p-1 bg-green-500 text-white hover:bg-green-600"
  1563→                            >
  1564→                              <Check className="w-4 h-4" />
  1565→                            </button>
  1566→                            <button
  1567→                              onClick={handleCancelEdit}
  1568→                              className="retro-btn p-1 bg-gray-500 text-white hover:bg-gray-600"
  1569→                            >
  1570→                              <X className="w-4 h-4" />
  1571→                            </button>
  1572→                          </>
  1573→                        ) : (
  1574→                          // 顯示模式
  1575→                          <>
  1576→                            <span
  1577→                              onClick={() => handleStartEdit(person)}
  1578→                              className="flex-1 font-bold text-gray-900 uppercase cursor-pointer hover:text-blue-600 transition-colors"
  1579→                              title="點擊編輯"
  1580→                            >
  1581→                              {person}
  1582→                            </span>
  1583→                            <button
  1584→                              onClick={() => handleDeletePerson(person)}
  1585→                              className="retro-btn p-1 bg-red-500 text-white hover:bg-red-600"
  1586→                            >
  1587→                              <Trash2 className="w-4 h-4" />
  1588→                            </button>
  1589→                          </>
  1590→                        )}
  1591→                      </div>
  1592→                    ))}
  1593→                  </div>
  1594→
  1595→                  {/* 新增人員 */}
  1596→                  <div className="flex gap-2">
  1597→                    <input
  1598→                      type="text"
  1599→                      value={newPersonName}
  1600→                      onChange={(e) => setNewPersonName(e.target.value)}
  1601→                      onKeyDown={(e) => e.key === 'Enter' && handleAddPerson()}
  1602→                      placeholder="NAME"
  1603→                      className="flex-1 px-3 py-2 border-2 border-gray-400 bg-white text-sm focus:outline-none focus:border-blue-500 uppercase"
  1604→                    />
  1605→                    <button
  1606→                      onClick={handleAddPerson}
  1607→                      disabled={!newPersonName.trim()}
  1608→                      className="retro-btn bg-blue-500 text-white px-4 py-2 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
  1609→                    >
  1610→                      <Plus className="w-5 h-5" />
  1611→                    </button>
  1612→                  </div>
  1613→                </div>
  1614→              </div>
  1615→            </motion.div>
  1616→          </>
  1617→        )}
  1618→      </AnimatePresence>
  1619→
  1620→      <AnimatePresence>
  1621→        {isPanelOpen && (
  1622→          <ContextPanel
  1623→            isOpen={true}
  1624→            onClose={handleClosePanel}
  1625→            task={selectedTask}
  1626→            onSave={handleSaveTask}
  1627→            onDelete={handleDeleteTask}
  1628→          />
  1629→        )}
  1630→      </AnimatePresence>
  1631→
  1632→      {/* 錯誤提示 */}
  1633→      {error && (
  1634→        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 border-2 border-gray-900 uppercase">
  1635→          ERROR: {error}
  1636→        </div>
  1637→      )}
  1638→    </div>
  1639→  );
  1640→};
  1641→
  1642→export default AppV2;
  1643→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./src/hooks/useTasks.ts`
```
     1→import { useState, useEffect, useCallback } from 'react';
     2→import { Task } from '../types';
     3→import { tasksApi } from '../api/client';
     4→
     5→export const useTasks = () => {
     6→  const [tasks, setTasks] = useState<Task[]>([]);
     7→  const [isLoading, setIsLoading] = useState(true);
     8→  const [isSyncing, setIsSyncing] = useState(false);
     9→  const [error, setError] = useState<string | null>(null);
    10→
    11→  const fetchTasks = useCallback(async () => {
    12→    setIsLoading(true);
    13→    setError(null);
    14→
    15→    try {
    16→      const loadedTasks = await tasksApi.getAll();
    17→      setTasks(loadedTasks);
    18→    } catch (err) {
    19→      console.error('Failed to fetch tasks:', err);
    20→      setError(err instanceof Error ? err.message : 'Failed to load tasks');
    21→    } finally {
    22→      setIsLoading(false);
    23→    }
    24→  }, []);
    25→
    26→  // Initial load
    27→  useEffect(() => {
    28→    fetchTasks();
    29→  }, [fetchTasks]);
    30→
    31→  const addTask = useCallback(async (task: Omit<Task, 'id'>) => {
    32→    setIsSyncing(true);
    33→    try {
    34→      const result = await tasksApi.create(task);
    35→      setTasks(prev => [...prev, result.task]);
    36→      return result.task;
    37→    } catch (err) {
    38→      console.error('Failed to add task:', err);
    39→      setError('Failed to add task');
    40→      throw err;
    41→    } finally {
    42→      setIsSyncing(false);
    43→    }
    44→  }, []);
    45→
    46→  const updateTask = useCallback(async (task: Task) => {
    47→    setIsSyncing(true);
    48→    try {
    49→      const result = await tasksApi.update(task);
    50→      setTasks(prev => prev.map(t =>
    51→        String(t.id) === String(task.id) ? result.task : t
    52→      ));
    53→      return result.task;
    54→    } catch (err) {
    55→      console.error('Failed to update task:', err);
    56→      setError('Failed to update task');
    57→      throw err;
    58→    } finally {
    59→      setIsSyncing(false);
    60→    }
    61→  }, []);
    62→
    63→  const deleteTask = useCallback(async (taskId: string) => {
    64→    setIsSyncing(true);
    65→    try {
    66→      await tasksApi.delete(taskId);
    67→      setTasks(prev => prev.filter(t => String(t.id) !== String(taskId)));
    68→    } catch (err) {
    69→      console.error('Failed to delete task:', err);
    70→      setError('Failed to delete task');
    71→      throw err;
    72→    } finally {
    73→      setIsSyncing(false);
    74→    }
    75→  }, []);
    76→
    77→  const saveTasks = useCallback(async (nextTasks: Task[]) => {
    78→    setIsSyncing(true);
    79→    try {
    80→      await tasksApi.bulkUpdate(nextTasks);
    81→      setTasks(nextTasks);
    82→    } catch (err) {
    83→      console.error('Sync failed:', err);
    84→      setError('Sync failed');
    85→      throw err;
    86→    } finally {
    87→      setIsSyncing(false);
    88→    }
    89→  }, []);
    90→
    91→  return {
    92→    tasks,
    93→    isLoading,
    94→    isSyncing,
    95→    error,
    96→    refetch: fetchTasks,
    97→    addTask,
    98→    updateTask,
    99→    deleteTask,
   100→    saveTasks,
   101→  };
   102→};
   103→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./src/components/Gantt/GanttChart.tsx`
```
     1→import React, { useMemo, useState } from 'react';
     2→import { motion } from 'framer-motion';
     3→import { ChevronLeft, ChevronRight } from 'lucide-react';
     4→import { Task, TaskPriority } from '../../types';
     5→
     6→// 計算兩個日期之間的天數差（end - start）
     7→const getDaysDiff = (start: Date, end: Date) => {
     8→  const oneDay = 24 * 60 * 60 * 1000;
     9→  return Math.round((end.getTime() - start.getTime()) / oneDay);
    10→};
    11→
    12→// 取得名字的前兩個字元作為頭像
    13→const getInitials = (name?: string): string => {
    14→  if (!name) return '??';
    15→  return name.substring(0, 2).toUpperCase();
    16→};
    17→
    18→// 優先級配置 - 用文字標籤
    19→const PRIORITY_CONFIG: Record<TaskPriority, { label: string; color: string; bgColor: string; textColor: string; order: number }> = {
    20→  'urgent': { label: 'URGENT', color: 'text-red-600', bgColor: 'bg-red-200', textColor: 'text-red-800', order: 0 },
    21→  'high': { label: 'HIGH', color: 'text-orange-600', bgColor: 'bg-amber-200', textColor: 'text-amber-800', order: 1 },
    22→  'medium': { label: 'MEDIUM', color: 'text-yellow-600', bgColor: 'bg-yellow-200', textColor: 'text-yellow-800', order: 2 },
    23→  'low': { label: 'LOW', color: 'text-gray-500', bgColor: 'bg-gray-200', textColor: 'text-gray-800', order: 3 },
    24→};
    25→
    26→const getPriorityOrder = (priority?: TaskPriority): number => {
    27→  if (!priority) return 99; // Not set priorities go last
    28→  return PRIORITY_CONFIG[priority]?.order ?? 99;
    29→};
    30→
    31→// 類別顏色映射
    32→const getCategoryColors = (category: string) => {
    33→  switch (category) {
    34→    case 'AI賦能':
    35→      return { color: 'bg-cyan-500', shadow: 'shadow-cyan-500/30' };
    36→    case '產品行銷':
    37→      return { color: 'bg-fuchsia-500', shadow: 'shadow-fuchsia-500/30' };
    38→    case '流程優化':
    39→      return { color: 'bg-amber-500', shadow: 'shadow-amber-500/30' };
    40→    case '品牌行銷':
    41→      return { color: 'bg-emerald-500', shadow: 'shadow-emerald-500/30' };
    42→    case '客戶開發':
    43→      return { color: 'bg-red-500', shadow: 'shadow-red-500/30' };
    44→    default:
    45→      return { color: 'bg-gray-500', shadow: 'shadow-gray-500/30' };
    46→  }
    47→};
    48→
    49→export const GanttChart = ({ tasks, onTaskClick }: { tasks: Task[], onTaskClick: (task: Task) => void }) => {
    50→  // 月份狀態管理
    51→  const [currentMonth, setCurrentMonth] = useState(() => {
    52→    const now = new Date();
    53→    return new Date(now.getFullYear(), now.getMonth(), 1);
    54→  });
    55→
    56→  const timelineStart = currentMonth;
    57→
    58→  const daysInMonth = useMemo(() => {
    59→    return new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
    60→  }, [currentMonth]);
    61→
    62→  // 計算今天在時間軸上的位置（0-indexed），如果不在當前月則返回 -1
    63→  const todayOffset = useMemo(() => {
    64→    const now = new Date();
    65→    const isCurrentMonth = now.getFullYear() === currentMonth.getFullYear() &&
    66→                          now.getMonth() === currentMonth.getMonth();
    67→    return isCurrentMonth ? now.getDate() - 1 : -1;
    68→  }, [currentMonth]);
    69→
    70→  // 月份切換函數
    71→  const goToPrevMonth = () => {
    72→    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
    73→  };
    74→
    75→  const goToNextMonth = () => {
    76→    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
    77→  };
    78→
    79→  const jumpToToday = () => {
    80→    const now = new Date();
    81→    setCurrentMonth(new Date(now.getFullYear(), now.getMonth(), 1));
    82→  };
    83→
    84→  // 格式化月份顯示
    85→  const monthLabel = useMemo(() => {
    86→    const year = currentMonth.getFullYear();
    87→    const month = currentMonth.toLocaleString('en-US', { month: 'short' }).toUpperCase();
    88→    return `${month}_${year}`;
    89→  }, [currentMonth]);
    90→
    91→  const dayWidth = 48;
    92→
    93→  const processedTasks = useMemo(() => {
    94→    const monthStart = timelineStart;
    95→    const monthEnd = new Date(timelineStart.getFullYear(), timelineStart.getMonth() + 1, 0);
    96→
    97→    return tasks
    98→      .filter(t => !t.isPoc) // 只顯示非 POC 任務
    99→      .filter(t => {
   100→        // 過濾：只顯示與當前月份有重疊的任務
   101→        const taskStart = new Date(t.startDate);
   102→        const taskEnd = new Date(t.endDate);
   103→        return taskEnd >= monthStart && taskStart <= monthEnd;
   104→      })
   105→      .map(t => {
   106→        const taskStart = new Date(t.startDate);
   107→        const taskEnd = new Date(t.endDate);
   108→
   109→        // 判斷是否跨月
   110→        const startsBeforeMonth = taskStart < monthStart;
   111→        const endsAfterMonth = taskEnd > monthEnd;
   112→
   113→        // 裁切顯示範圍
   114→        const displayStart = startsBeforeMonth ? monthStart : taskStart;
   115→        const displayEnd = endsAfterMonth ? monthEnd : taskEnd;
   116→
   117→        // 計算顯示位置和長度
   118→        const offsetDays = getDaysDiff(monthStart, displayStart);
   119→        const duration = getDaysDiff(displayStart, displayEnd) + 1;
   120→
   121→        const { color, shadow } = getCategoryColors(t.category);
   122→
   123→        return {
   124→          ...t,
   125→          offsetDays,
   126→          duration,
   127→          color,
   128→          shadow,
   129→          continueFromPrev: startsBeforeMonth,
   130→          continueToNext: endsAfterMonth,
   131→        };
   132→      })
   133→      // 排序：完成狀態 > 優先級 > 開始日期
   134→      .sort((a, b) => {
   135→        // 1. 已完成的排最後
   136→        const aCompleted = a.status === 'completed' ? 1 : 0;
   137→        const bCompleted = b.status === 'completed' ? 1 : 0;
   138→        if (aCompleted !== bCompleted) return aCompleted - bCompleted;
   139→
   140→        // 2. 優先級
   141→        const priorityDiff = getPriorityOrder(a.priority) - getPriorityOrder(b.priority);
   142→        if (priorityDiff !== 0) return priorityDiff;
   143→
   144→        // 3. 開始日期
   145→        return new Date(a.startDate).getTime() - new Date(b.startDate).getTime();
   146→      });
   147→  }, [tasks, timelineStart]);
   148→
   149→  return (
   150→    <div className="retro-panel p-0 h-full overflow-auto custom-scrollbar relative">
   151→      <div className="min-w-fit flex flex-col relative">
   152→
   153→        {/* Month Navigation - Sticky Top */}
   154→        <div className="retro-panel p-2 flex items-center justify-between sticky top-0 z-50">
   155→          <button
   156→            onClick={goToPrevMonth}
   157→            className="retro-btn bg-gray-700 text-white px-4 py-2 hover:bg-gray-800"
   158→          >
   159→            <ChevronLeft className="w-4 h-4" />
   160→            <span className="text-xs font-bold uppercase">PREV</span>
   161→          </button>
   162→
   163→          <span className="text-lg font-bold text-gray-900 uppercase tracking-wider">{monthLabel}</span>
   164→
   165→          <button
   166→            onClick={goToNextMonth}
   167→            className="retro-btn bg-gray-700 text-white px-4 py-2 hover:bg-gray-800"
   168→          >
   169→            <span className="text-xs font-bold uppercase">NEXT</span>
   170→            <ChevronRight className="w-4 h-4" />
   171→          </button>
   172→        </div>
   173→
   174→        {/* Header Row - Sticky Top */}
   175→        <div className="sticky top-0 z-40 flex h-16 bg-gray-100 border-b-2 border-gray-900 shadow-sm">
   176→          {/* Corner (Task Name) - Sticky Left + Top */}
   177→          <div className="sticky left-0 z-50 w-[250px] shrink-0 bg-gray-100 border-r-2 border-gray-900 flex items-center pl-6 font-bold text-gray-800 text-xs tracking-wider uppercase">
   178→            TASK_NAME
   179→          </div>
   180→          
   181→          {/* Date Header - Scrollable horizontally */}
   182→          <div className="flex">
   183→            {Array.from({ length: daysInMonth }).map((_, i) => {
   184→              const d = new Date(timelineStart);
   185→              d.setDate(d.getDate() + i);
   186→              const isToday = i === todayOffset;
   187→              return (
   188→                <div
   189→                  key={i}
   190→                  className={`w-12 shrink-0 text-center text-xs font-bold border-r border-gray-300 flex items-center justify-center
   191→                    ${isToday ? 'bg-cyan-100 text-cyan-800 border-cyan-500' : 'text-gray-600'}`}
   192→                >
   193→                  {d.getDate()}
   194→                </div>
   195→              );
   196→            })}
   197→          </div>
   198→        </div>
   199→
   200→        {/* Body Section */}
   201→        <div className="flex flex-1 relative">
   202→          
   203→          {/* Left Sidebar - Sticky Left */}
   204→          <div className="sticky left-0 z-30 w-[250px] shrink-0 bg-gray-100 border-r-2 border-gray-900">
   205→            {processedTasks.map((task) => {
   206→              const priorityConfig = task.priority ? PRIORITY_CONFIG[task.priority] : null;
   207→              return (
   208→                <div
   209→                  key={task.id}
   210→                  className="h-14 flex items-center px-3 border-b border-gray-300 hover:bg-gray-200 transition-colors cursor-pointer group"
   211→                  onClick={() => onTaskClick(task)}
   212→                >
   213→                  {/* 優先級文字標籤 */}
   214→                  <div className={`px-2 py-1 border border-gray-900 text-[10px] font-bold mr-2 shrink-0 ${priorityConfig ? `${priorityConfig.bgColor} ${priorityConfig.textColor}` : 'bg-gray-200 text-gray-800'}`}>
   215→                    {priorityConfig?.label || 'NONE'}
   216→                  </div>
   217→
   218→                  {/* 負責人頭像 */}
   219→                  <div className={`w-8 h-8 bg-black text-white text-[10px] font-bold flex items-center justify-center border border-gray-900 mr-2 shrink-0`}>
   220→                    {getInitials(task.owner)}
   221→                  </div>
   222→
   223→                  {/* 任務名稱 */}
   224→                  <span className="text-sm font-bold text-gray-800 group-hover:text-blue-600 transition-colors truncate uppercase">
   225→                    {task.name}
   226→                  </span>
   227→                </div>
   228→              );
   229→            })}
   230→          </div>
   231→
   232→          {/* Right Gantt Area */}
   233→          <div className="relative flex-1">
   234→            
   235→            {/* Grid Lines (Background) */}
   236→            <div className="absolute inset-0 flex pointer-events-none z-0">
   237→              {Array.from({ length: daysInMonth }).map((_, j) => (
   238→                <div
   239→                  key={j}
   240→                  className={`w-12 shrink-0 border-r border-gray-300 h-full
   241→                    ${j === todayOffset ? 'bg-blue-50/50' : j % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}
   242→                />
   243→              ))}
   244→            </div>
   245→
   246→            {/* Today Line Indicator - Only show if in current month */}
   247→            {todayOffset >= 0 && (
   248→              <div
   249→                className="absolute top-0 bottom-0 z-20 pointer-events-none border-l-2 border-cyan-500 border-solid"
   250→                style={{ left: `${todayOffset * dayWidth + dayWidth / 2}px` }}
   251→              >
   252→                <div className="absolute -top-1 -left-[5px] w-2.5 h-2.5 bg-cyan-500 border border-gray-900" />
   253→              </div>
   254→            )}
   255→
   256→            {/* Task Bars (Foreground) */}
   257→            <div className="relative z-10 w-full">
   258→              {processedTasks.map((task) => {
   259→                // 計算條狀位置和寬度
   260→                const barLeft = task.offsetDays * dayWidth;
   261→                const barWidth = Math.max(task.duration * dayWidth, 48); // 最小寬度 48px
   262→
   263→                return (
   264→                  <div key={task.id} className="h-14 flex items-center relative">
   265→                    <motion.div
   266→                      layoutId={`task-${task.id}`}
   267→                      onClick={(e) => {
   268→                        e.preventDefault();
   269→                        e.stopPropagation();
   270→                        onTaskClick(task);
   271→                      }}
   272→                      className={`absolute h-8 ${task.color} ${task.shadow} tech-bar flex items-center justify-center text-white text-xs font-bold cursor-pointer hover:brightness-110 hover:scale-[1.02] active:scale-95 transition-all z-50`}
   273→                      style={{
   274→                        left: `${barLeft}px`,
   275→                        width: `${barWidth}px`
   276→                      }}
   277→                    >
   278→                      <span className="drop-shadow-md pointer-events-none relative z-10 flex items-center justify-between w-full px-2">
   279→                        {(task as any).continueFromPrev ? (
   280→                          <span className="text-[10px] text-red-400">← from上月</span>
   281→                        ) : <span></span>}
   282→                        <span>{task.progress}%</span>
   283→                        {(task as any).continueToNext ? (
   284→                          <span className="text-[10px] text-red-400">to下月 →</span>
   285→                        ) : <span></span>}
   286→                      </span>
   287→                    </motion.div>
   288→                  </div>
   289→                );
   290→              })}
   291→            </div>
   292→          </div>
   293→        </div>
   294→      </div>
   295→    </div>
   296→  );
   297→};

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<think><details><summary>Thought Process</summary>
好的，我已經檢查了主要的代碼。讓我分析可能導致 Windows Server 記憶體吃到 10GB 的原因：從程式碼中我可以看到幾個可能導致高記憶體使用的問題：

1. **Base64 圖片儲存** (server.js:19, 62-70):
   - payload limit 設定為 15MB
   - 如果有大量圖片附件以 base64 儲存在 materials 中，會佔用大量記憶體
   - 從 AppV2.tsx (1201-1216, 1247-1256) 可以看到支持上傳圖片和檔案並轉成 base64

2. **React 組件沒有正確清理**:
   - 大量 useState 和 useMemo (AppV2.tsx)
   - AnimatePresence 和 motion 組件可能導致記憶體洩漏
   - 沒有看到 useEffect cleanup 函數

3. **任務數據沒有分頁**:
   - 所有任務一次性載入到記憶體 (useTasks.ts:16-18)
   - processedTasks 使用 useMemo 但沒有限制數量 (GanttChart.tsx:93-147)

4. **圖片預覽沒有釋放** (AppV2.tsx:1219-1228):
   - FileReader 讀取的 dataUrl 會一直保存在 state 中
   - 沒有 URL.revokeObjectURL() 釋放

5. **localStorage 儲存大量數據**:
   - 人員數據持續保存在瀏覽器本地儲存空間
   - 可能累積大量未清理的歷史數據

我注意到本地儲存機制可能是記憶體消耗的另一個潛在來源。需要進一步檢查數據管理和清理策略。
</details></think>

_**Agent (claude-sonnet-4-5-20250929)**_

讓我再檢查一下 API 客戶端和存儲相關的代碼：

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./src/api/client.ts`
```
     1→// API 基礎路徑 - 使用同源 /api
     2→export const getApiBaseUrl = () => {
     3→  // 開發環境使用代理，生產環境使用同源
     4→  if (typeof window !== 'undefined') {
     5→    return window.location.origin;
     6→  }
     7→  return '';
     8→};
     9→
    10→// Tasks API
    11→export const tasksApi = {
    12→  async getAll() {
    13→    const res = await fetch(`${getApiBaseUrl()}/api/tasks`);
    14→    if (!res.ok) throw new Error(`Failed to fetch tasks: ${res.status}`);
    15→    const data = await res.json();
    16→    return data.tasks || [];
    17→  },
    18→
    19→  async create(task: any) {
    20→    const res = await fetch(`${getApiBaseUrl()}/api/tasks`, {
    21→      method: 'POST',
    22→      headers: { 'Content-Type': 'application/json' },
    23→      body: JSON.stringify(task),
    24→    });
    25→    if (!res.ok) throw new Error(`Failed to create task: ${res.status}`);
    26→    return res.json();
    27→  },
    28→
    29→  async update(task: any) {
    30→    const res = await fetch(`${getApiBaseUrl()}/api/tasks`, {
    31→      method: 'PUT',
    32→      headers: { 'Content-Type': 'application/json' },
    33→      body: JSON.stringify(task),
    34→    });
    35→    if (!res.ok) throw new Error(`Failed to update task: ${res.status}`);
    36→    return res.json();
    37→  },
    38→
    39→  async bulkUpdate(tasks: any[]) {
    40→    const res = await fetch(`${getApiBaseUrl()}/api/tasks`, {
    41→      method: 'PUT',
    42→      headers: { 'Content-Type': 'application/json' },
    43→      body: JSON.stringify(tasks),
    44→    });
    45→    if (!res.ok) throw new Error(`Failed to bulk update tasks: ${res.status}`);
    46→    return res.json();
    47→  },
    48→
    49→  async delete(id: string) {
    50→    const res = await fetch(`${getApiBaseUrl()}/api/tasks?id=${id}`, {
    51→      method: 'DELETE',
    52→    });
    53→    if (!res.ok) throw new Error(`Failed to delete task: ${res.status}`);
    54→    return res.json();
    55→  },
    56→};
    57→
    58→// Notes API
    59→export const notesApi = {
    60→  async getAll() {
    61→    const res = await fetch(`${getApiBaseUrl()}/api/notes`);
    62→    if (!res.ok) throw new Error(`Failed to fetch notes: ${res.status}`);
    63→    const data = await res.json();
    64→    return data.notes || [];
    65→  },
    66→
    67→  async create(note: any) {
    68→    const res = await fetch(`${getApiBaseUrl()}/api/notes`, {
    69→      method: 'POST',
    70→      headers: { 'Content-Type': 'application/json' },
    71→      body: JSON.stringify(note),
    72→    });
    73→    if (!res.ok) throw new Error(`Failed to create note: ${res.status}`);
    74→    return res.json();
    75→  },
    76→
    77→  async update(note: any) {
    78→    const res = await fetch(`${getApiBaseUrl()}/api/notes`, {
    79→      method: 'PUT',
    80→      headers: { 'Content-Type': 'application/json' },
    81→      body: JSON.stringify(note),
    82→    });
    83→    if (!res.ok) throw new Error(`Failed to update note: ${res.status}`);
    84→    return res.json();
    85→  },
    86→
    87→  async bulkUpdate(notes: any[]) {
    88→    const res = await fetch(`${getApiBaseUrl()}/api/notes`, {
    89→      method: 'PUT',
    90→      headers: { 'Content-Type': 'application/json' },
    91→      body: JSON.stringify(notes),
    92→    });
    93→    if (!res.ok) throw new Error(`Failed to bulk update notes: ${res.status}`);
    94→    return res.json();
    95→  },
    96→
    97→  async delete(id: string) {
    98→    const res = await fetch(`${getApiBaseUrl()}/api/notes?id=${id}`, {
    99→      method: 'DELETE',
   100→    });
   101→    if (!res.ok) throw new Error(`Failed to delete note: ${res.status}`);
   102→    return res.json();
   103→  },
   104→};
   105→
   106→// Attachments API
   107→export const attachmentsApi = {
   108→  async upload(name: string, type: string, dataUrl: string) {
   109→    const res = await fetch(`${getApiBaseUrl()}/api/attachments`, {
   110→      method: 'POST',
   111→      headers: { 'Content-Type': 'application/json' },
   112→      body: JSON.stringify({ name, type, dataUrl }),
   113→    });
   114→    if (!res.ok) throw new Error(`Failed to upload attachment: ${res.status}`);
   115→    return res.json();
   116→  },
   117→
   118→  async get(id: string) {
   119→    const res = await fetch(`${getApiBaseUrl()}/api/attachments?id=${id}`);
   120→    if (!res.ok) throw new Error(`Failed to get attachment: ${res.status}`);
   121→    return res.json();
   122→  },
   123→
   124→  async delete(id: string) {
   125→    const res = await fetch(`${getApiBaseUrl()}/api/attachments?id=${id}`, {
   126→      method: 'DELETE',
   127→    });
   128→    if (!res.ok) throw new Error(`Failed to delete attachment: ${res.status}`);
   129→    return res.json();
   130→  },
   131→};
   132→
   133→// Calendar API
   134→export const calendarApi = {
   135→  async getAll(person: 'ja' | 'jo') {
   136→    const res = await fetch(`${getApiBaseUrl()}/api/calendar?person=${person}`);
   137→    if (!res.ok) throw new Error(`Failed to fetch calendar: ${res.status}`);
   138→    const data = await res.json();
   139→    return data.entries || {};
   140→  },
   141→
   142→  async update(person: 'ja' | 'jo', entries: any) {
   143→    const res = await fetch(`${getApiBaseUrl()}/api/calendar?person=${person}`, {
   144→      method: 'PUT',
   145→      headers: { 'Content-Type': 'application/json' },
   146→      body: JSON.stringify(entries),
   147→    });
   148→    if (!res.ok) throw new Error(`Failed to update calendar: ${res.status}`);
   149→    return res.json();
   150→  },
   151→
   152→  async updateEntry(person: 'ja' | 'jo', date: string, entry: any) {
   153→    const res = await fetch(`${getApiBaseUrl()}/api/calendar?person=${person}`, {
   154→      method: 'POST',
   155→      headers: { 'Content-Type': 'application/json' },
   156→      body: JSON.stringify({ date, entry }),
   157→    });
   158→    if (!res.ok) throw new Error(`Failed to update calendar entry: ${res.status}`);
   159→    return res.json();
   160→  },
   161→
   162→  async deleteEntry(person: 'ja' | 'jo', date: string) {
   163→    const res = await fetch(`${getApiBaseUrl()}/api/calendar?person=${person}&date=${date}`, {
   164→      method: 'DELETE',
   165→    });
   166→    if (!res.ok) throw new Error(`Failed to delete calendar entry: ${res.status}`);
   167→    return res.json();
   168→  },
   169→};
   170→
   171→// 保留舊的 resolveApiBaseUrl 供向後兼容
   172→export const resolveApiBaseUrl = getApiBaseUrl;
   173→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./backend/storage.js`
```
     1→import { promises as fs } from 'fs';
     2→import path from 'path';
     3→import { fileURLToPath } from 'url';
     4→import { createClient } from 'redis';
     5→
     6→const __filename = fileURLToPath(import.meta.url);
     7→const __dirname = path.dirname(__filename);
     8→
     9→const LEGACY_SEED_DATA_FILE = path.join(__dirname, 'tasks.json');
    10→
    11→const hasRemoteKv = Boolean(process.env.KV_REST_API_URL && process.env.KV_REST_API_TOKEN);
    12→const hasRedis = Boolean(process.env.REDIS_URL);
    13→
    14→const LEGACY_KV_KEY = process.env.KV_KEY || 'gantt:tasks';
    15→const WORKSPACE_COLLECTION_KEY = process.env.WORKSPACE_COLLECTION_KEY || 'gantt:workspaces:v1';
    16→export const DEFAULT_WORKSPACE_ID = process.env.DEFAULT_WORKSPACE_ID || 'default';
    17→
    18→const WORKSPACE_VERSION = 1;
    19→const DEFAULT_PROJECT_TITLE = '繽紛七彩酷炫甘特圖';
    20→const DEFAULT_NEW_WORKSPACE_TITLE = '請輸入甘特圖名稱';
    21→
    22→let redisClient = null;
    23→
    24→const workspacePalette = [
    25→  '#6366f1',
    26→  '#ec4899',
    27→  '#06b6d4',
    28→  '#f59e0b',
    29→  '#10b981',
    30→  '#f97316',
    31→  '#8b5cf6',
    32→  '#0ea5e9',
    33→];
    34→
    35→const createEmptyCollection = () => ({
    36→  version: WORKSPACE_VERSION,
    37→  updatedAt: new Date().toISOString(),
    38→  defaultWorkspaceId: DEFAULT_WORKSPACE_ID,
    39→  workspaces: {},
    40→});
    41→
    42→const createWorkspaceSkeleton = ({
    43→  id,
    44→  name,
    45→  owner = '',
    46→  color,
    47→  viewRange = { start: '', end: '' },
    48→  status = 'active',
    49→  source = 'system',
    50→} = {}) => {
    51→  const now = new Date().toISOString();
    52→  const rangeMode =
    53→    viewRange && viewRange.start && viewRange.end ? 'custom' : 'auto';
    54→
    55→  const safeName =
    56→    typeof name === 'string' && name.trim()
    57→      ? name.trim()
    58→      : source === 'user'
    59→      ? DEFAULT_NEW_WORKSPACE_TITLE
    60→      : DEFAULT_PROJECT_TITLE;
    61→
    62→  return {
    63→    id,
    64→    name: safeName,
    65→    owner,
    66→    status,
    67→    color,
    68→    createdAt: now,
    69→    updatedAt: now,
    70→    lastSyncedAt: now,
    71→    source,
    72→    tasks: [],
    73→    settings: {
    74→      projectTitle: safeName,
    75→      rangeMode,
    76→      viewRange,
    77→    },
    78→  };
    79→};
    80→
    81→const createEmptyState = () => ({
    82→  tasks: [],
    83→  settings: {},
    84→});
    85→
    86→export const normalizeWorkspaceState = (value) => {
    87→  if (Array.isArray(value)) {
    88→    return {
    89→      tasks: value,
    90→      settings: {},
    91→    };
    92→  }
    93→
    94→  if (value && typeof value === 'object') {
    95→    const tasks = Array.isArray(value.tasks) ? value.tasks : [];
    96→    const settings =
    97→      value.settings && typeof value.settings === 'object' ? value.settings : {};
    98→
    99→    return {
   100→      tasks,
   101→      settings,
   102→    };
   103→  }
   104→
   105→  return createEmptyState();
   106→};
   107→
   108→let workspaceCollectionCache = globalThis.__GANTT_WORKSPACE_COLLECTION || null;
   109→globalThis.__GANTT_WORKSPACE_COLLECTION = workspaceCollectionCache;
   110→
   111→const ensureRemoteConfigured = () => {
   112→  if (!hasRedis && !hasRemoteKv) {
   113→    throw new Error(
   114→      '[storage] Remote storage is not configured. Please set REDIS_URL or KV_REST_API_URL/KV_REST_API_TOKEN.',
   115→    );
   116→  }
   117→};
   118→
   119→const getRedisClient = async () => {
   120→  if (!hasRedis) {
   121→    return null;
   122→  }
   123→
   124→  if (!redisClient) {
   125→    redisClient = createClient({
   126→      url: process.env.REDIS_URL,
   127→    });
   128→
   129→    redisClient.on('error', (err) => {
   130→      console.error('[storage] Redis client error', err);
   131→    });
   132→  }
   133→
   134→  if (!redisClient.isOpen) {
   135→    await redisClient.connect();
   136→  }
   137→
   138→  return redisClient;
   139→};
   140→
   141→const requestKv = async (command, ...args) => {
   142→  const baseUrl = process.env.KV_REST_API_URL;
   143→  const token = process.env.KV_REST_API_TOKEN;
   144→
   145→  if (!baseUrl || !token) {
   146→    throw new Error('KV_REST_API_URL or KV_REST_API_TOKEN is not set');
   147→  }
   148→
   149→  const url = [baseUrl.replace(/\/$/, ''), command, ...args.map((arg) => encodeURIComponent(arg))].join('/');
   150→  const response = await fetch(url, {
   151→    headers: {
   152→      Authorization: `Bearer ${token}`,
   153→    },
   154→  });
   155→
   156→  if (!response.ok) {
   157→    throw new Error(`KV request failed: ${response.status} ${response.statusText}`);
   158→  }
   159→
   160→  return response.json();
   161→};
   162→
   163→const readRemoteKey = async (key) => {
   164→  ensureRemoteConfigured();
   165→
   166→  let redis = null;
   167→  try {
   168→    redis = await getRedisClient();
   169→  } catch (error) {
   170→    console.warn('[storage] Redis connection failed, skipping Redis read');
   171→    console.error('[storage] Redis connection error details:', {
   172→      message: error?.message,
   173→      stack: error?.stack,
   174→    });
   175→  }
   176→
   177→  if (redis) {
   178→    try {
   179→      const value = await redis.get(key);
   180→      if (value) {
   181→        return value;
   182→      }
   183→    } catch (error) {
   184→      console.error('[storage] Unable to read from Redis', {
   185→        message: error?.message,
   186→        stack: error?.stack,
   187→      });
   188→    }
   189→  }
   190→
   191→  if (hasRemoteKv) {
   192→    try {
   193→      const result = await requestKv('get', key);
   194→      if (result && typeof result.result === 'string') {
   195→        return result.result;
   196→      }
   197→    } catch (error) {
   198→      console.error('[storage] Unable to read from KV', {
   199→        message: error?.message,
   200→        stack: error?.stack,
   201→      });
   202→    }
   203→  }
   204→
   205→  return null;
   206→};
   207→
   208→const writeRemoteKey = async (key, value) => {
   209→  ensureRemoteConfigured();
   210→
   211→  let persisted = false;
   212→  let redis = null;
   213→  try {
   214→    redis = await getRedisClient();
   215→  } catch (error) {
   216→    console.warn('[storage] Redis connection failed, skipping Redis save');
   217→    console.error('[storage] Redis connection error details:', {
   218→      message: error?.message,
   219→      stack: error?.stack,
   220→    });
   221→  }
   222→
   223→  if (redis) {
   224→    try {
   225→      await redis.set(key, value);
   226→      persisted = true;
   227→    } catch (error) {
   228→      console.error('[storage] Failed to write to Redis', {
   229→        message: error?.message,
   230→        stack: error?.stack,
   231→      });
   232→    }
   233→  }
   234→
   235→  if (hasRemoteKv) {
   236→    try {
   237→      await requestKv('set', key, value);
   238→      persisted = true;
   239→    } catch (error) {
   240→      console.error('[storage] Failed to write to KV', {
   241→        message: error?.message,
   242→        stack: error?.stack,
   243→      });
   244→    }
   245→  }
   246→
   247→  if (!persisted) {
   248→    throw new Error('[storage] Unable to persist workspaces to any configured remote store');
   249→  }
   250→};
   251→
   252→const deserializeCollection = (raw) => {
   253→  if (!raw) return null;
   254→  try {
   255→    const parsed = JSON.parse(raw);
   256→    if (parsed && typeof parsed === 'object' && parsed.workspaces) {
   257→      return parsed;
   258→    }
   259→    if (parsed && Array.isArray(parsed.tasks)) {
   260→      return {
   261→        version: WORKSPACE_VERSION,
   262→        updatedAt: new Date().toISOString(),
   263→        defaultWorkspaceId: DEFAULT_WORKSPACE_ID,
   264→        workspaces: {
   265→          [DEFAULT_WORKSPACE_ID]: {
   266→            ...createWorkspaceSkeleton({
   267→              id: DEFAULT_WORKSPACE_ID,
   268→              name: parsed.settings?.projectTitle || DEFAULT_PROJECT_TITLE,
   269→            }),
   270→            tasks: parsed.tasks,
   271→            settings: parsed.settings && typeof parsed.settings === 'object'
   272→              ? parsed.settings
   273→              : { projectTitle: DEFAULT_PROJECT_TITLE, rangeMode: 'auto', viewRange: { start: '', end: '' } },
   274→            lastSyncedAt: new Date().toISOString(),
   275→          },
   276→        },
   277→      };
   278→    }
   279→  } catch (error) {
   280→    console.error('[storage] Failed to parse workspace collection', error);
   281→  }
   282→  return null;
   283→};
   284→
   285→const hydrateCollection = async () => {
   286→  if (workspaceCollectionCache) {
   287→    return workspaceCollectionCache;
   288→  }
   289→
   290→  ensureRemoteConfigured();
   291→
   292→  let collection = null;
   293→
   294→  // Try current workspace collection key
   295→  const rawCollection = await readRemoteKey(WORKSPACE_COLLECTION_KEY);
   296→  if (rawCollection) {
   297→    collection = deserializeCollection(rawCollection);
   298→  }
   299→
   300→  // Attempt to migrate from legacy key if needed
   301→  if (!collection) {
   302→    const legacyRaw = await readRemoteKey(LEGACY_KV_KEY);
   303→    if (legacyRaw) {
   304→      collection = deserializeCollection(legacyRaw);
   305→      if (collection) {
   306→        console.log('[storage] Migrated legacy workspace state into new collection format');
   307→        await writeRemoteKey(WORKSPACE_COLLECTION_KEY, JSON.stringify(collection));
   308→      }
   309→    }
   310→  }
   311→
   312→  // Final fallback: seed file
   313→  if (!collection) {
   314→    try {
   315→      const seedRaw = await fs.readFile(LEGACY_SEED_DATA_FILE, 'utf8');
   316→      collection = deserializeCollection(seedRaw);
   317→      if (collection) {
   318→        console.log('[storage] Seeded collection from local tasks.json');
   319→        await writeRemoteKey(WORKSPACE_COLLECTION_KEY, JSON.stringify(collection));
   320→      }
   321→    } catch (error) {
   322→      if (error?.code !== 'ENOENT') {
   323→        console.error('[storage] Failed to read seed file', {
   324→          message: error?.message,
   325→          stack: error?.stack,
   326→        });
   327→      }
   328→    }
   329→  }
   330→
   331→  if (!collection) {
   332→    console.warn('[storage] No existing workspaces found, creating empty collection');
   333→    collection = createEmptyCollection();
   334→    collection.workspaces[DEFAULT_WORKSPACE_ID] = createWorkspaceSkeleton({
   335→      id: DEFAULT_WORKSPACE_ID,
   336→      name: DEFAULT_PROJECT_TITLE,
   337→      source: 'generated',
   338→    });
   339→    await writeRemoteKey(WORKSPACE_COLLECTION_KEY, JSON.stringify(collection));
   340→  }
   341→
   342→  if (!collection.workspaces[DEFAULT_WORKSPACE_ID]) {
   343→    console.warn('[storage] Default workspace missing, creating placeholder');
   344→    collection.workspaces[DEFAULT_WORKSPACE_ID] = createWorkspaceSkeleton({
   345→      id: DEFAULT_WORKSPACE_ID,
   346→      name: DEFAULT_PROJECT_TITLE,
   347→      source: 'generated',
   348→    });
   349→  }
   350→
   351→  workspaceCollectionCache = collection;
   352→  globalThis.__GANTT_WORKSPACE_COLLECTION = workspaceCollectionCache;
   353→  return workspaceCollectionCache;
   354→};
   355→
   356→const persistCollection = async (collection) => {
   357→  const payload = JSON.stringify({
   358→    ...collection,
   359→    updatedAt: new Date().toISOString(),
   360→  });
   361→  await writeRemoteKey(WORKSPACE_COLLECTION_KEY, payload);
   362→  workspaceCollectionCache = {
   363→    ...collection,
   364→    updatedAt: new Date().toISOString(),
   365→  };
   366→  globalThis.__GANTT_WORKSPACE_COLLECTION = workspaceCollectionCache;
   367→  return workspaceCollectionCache;
   368→};
   369→
   370→const pickWorkspaceColor = (collection) => {
   371→  const existingCount = Object.keys(collection.workspaces || {}).length;
   372→  return workspacePalette[existingCount % workspacePalette.length];
   373→};
   374→
   375→export const listWorkspaces = async () => {
   376→  const collection = await hydrateCollection();
   377→  const entries = Object.values(collection.workspaces || {});
   378→
   379→  return entries
   380→    .map((workspace) => ({
   381→      id: workspace.id,
   382→      name: workspace.name || workspace.settings?.projectTitle || DEFAULT_PROJECT_TITLE,
   383→      owner: workspace.owner || '',
   384→      status: workspace.status || 'active',
   385→      color: workspace.color || pickWorkspaceColor(collection),
   386→      taskCount: Array.isArray(workspace.tasks) ? workspace.tasks.length : 0,
   387→      range: workspace.settings?.viewRange || { start: '', end: '' },
   388→      rangeMode: workspace.settings?.rangeMode || 'auto',
   389→      updatedAt: workspace.updatedAt || workspace.lastSyncedAt || workspace.createdAt,
   390→      createdAt: workspace.createdAt,
   391→      lastSyncedAt: workspace.lastSyncedAt || workspace.updatedAt,
   392→      projectTitle: workspace.settings?.projectTitle || workspace.name || DEFAULT_PROJECT_TITLE,
   393→    }))
   394→    .sort((a, b) => {
   395→      const dateA = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
   396→      const dateB = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
   397→      return dateB - dateA;
   398→    });
   399→};
   400→
   401→export const loadWorkspace = async (workspaceId = DEFAULT_WORKSPACE_ID) => {
   402→  const collection = await hydrateCollection();
   403→  const workspace = collection.workspaces[workspaceId];
   404→  if (!workspace) {
   405→    return null;
   406→  }
   407→  return {
   408→    tasks: Array.isArray(workspace.tasks) ? workspace.tasks : [],
   409→    settings: workspace.settings || {},
   410→    meta: {
   411→      id: workspace.id,
   412→      name: workspace.name,
   413→      owner: workspace.owner,
   414→      status: workspace.status,
   415→      color: workspace.color,
   416→      createdAt: workspace.createdAt,
   417→      updatedAt: workspace.updatedAt,
   418→      lastSyncedAt: workspace.lastSyncedAt,
   419→    },
   420→  };
   421→};
   422→
   423→export const saveWorkspace = async (workspaceId, stateInput, metaOverride = {}) => {
   424→  if (!workspaceId) {
   425→    throw new Error('[storage] saveWorkspace requires a workspaceId');
   426→  }
   427→
   428→  const collection = await hydrateCollection();
   429→  const normalized = normalizeWorkspaceState(stateInput);
   430→  const taskCount = normalized.tasks.length;
   431→  const now = new Date().toISOString();
   432→
   433→  let workspace = collection.workspaces[workspaceId];
   434→  if (!workspace) {
   435→    workspace = createWorkspaceSkeleton({
   436→      id: workspaceId,
   437→      name: metaOverride?.name || DEFAULT_PROJECT_TITLE,
   438→      owner: metaOverride?.owner || '',
   439→      color: pickWorkspaceColor(collection),
   440→    });
   441→    collection.workspaces[workspaceId] = workspace;
   442→  }
   443→
   444→  workspace.tasks = normalized.tasks;
   445→  workspace.settings = {
   446→    ...workspace.settings,
   447→    ...normalized.settings,
   448→  };
   449→
   450→  workspace.updatedAt = now;
   451→  workspace.lastSyncedAt = now;
   452→  workspace.status = metaOverride?.status || workspace.status || 'active';
   453→  workspace.name = metaOverride?.name || workspace.settings?.projectTitle || workspace.name;
   454→  workspace.owner = metaOverride?.owner ?? workspace.owner ?? '';
   455→  workspace.color = metaOverride?.color || workspace.color || pickWorkspaceColor(collection);
   456→
   457→  await persistCollection(collection);
   458→  console.log(`[storage] Saved workspace "${workspaceId}" with ${taskCount} tasks`);
   459→  return {
   460→    tasks: workspace.tasks,
   461→    settings: workspace.settings,
   462→  };
   463→};
   464→
   465→export const createWorkspace = async ({ name, owner, range } = {}) => {
   466→  const collection = await hydrateCollection();
   467→  const id = `ws_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
   468→  const color = pickWorkspaceColor(collection);
   469→  const viewRange = range && range.start && range.end ? range : { start: '', end: '' };
   470→
   471→  collection.workspaces[id] = createWorkspaceSkeleton({
   472→    id,
   473→    name: name || DEFAULT_PROJECT_TITLE,
   474→    owner: owner || '',
   475→    color,
   476→    viewRange,
   477→    status: 'active',
   478→    source: 'user',
   479→  });
   480→
   481→  await persistCollection(collection);
   482→  return {
   483→    id,
   484→    name: collection.workspaces[id].name,
   485→    owner: collection.workspaces[id].owner,
   486→    color: collection.workspaces[id].color,
   487→    status: collection.workspaces[id].status,
   488→    range: collection.workspaces[id].settings.viewRange,
   489→    createdAt: collection.workspaces[id].createdAt,
   490→    updatedAt: collection.workspaces[id].updatedAt,
   491→  };
   492→};
   493→
   494→export const deleteWorkspace = async (workspaceId) => {
   495→  if (workspaceId === DEFAULT_WORKSPACE_ID) {
   496→    throw new Error('[storage] Default workspace cannot be deleted');
   497→  }
   498→
   499→  const collection = await hydrateCollection();
   500→  if (!collection.workspaces[workspaceId]) {
   501→    return false;
   502→  }
   503→
   504→  delete collection.workspaces[workspaceId];
   505→  await persistCollection(collection);
   506→  return true;
   507→};
   508→
   509→export const loadTasks = async () => {
   510→  const workspace = await loadWorkspace(DEFAULT_WORKSPACE_ID);
   511→  return workspace || createEmptyState();
   512→};
   513→
   514→export const saveTasks = async (stateInput) => {
   515→  return saveWorkspace(DEFAULT_WORKSPACE_ID, stateInput);
   516→};
   517→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="bash" data-tool-name="Bash"><details>
<summary>Tool use: **Bash**</summary>
 檢查 tasks.json 檔案大小

`du -sh /Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/tasks.json 2>/dev/null || echo "tasks.json not found"`
```
8.0K	/Users/jill/Documents/coding_projects/專案/甘特圖專案管理/backend/tasks.json
```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<think><details><summary>Thought Process</summary>
好的，我現在可以看到整個架構了。讓我總結一下可能導致記憶體問題的原因：

1. **Redis/KV 儲存層** (storage.js):
   - 使用全域變數 `workspaceCollectionCache` 和 `globalThis.__GANTT_WORKSPACE_COLLECTION` (108-109, 351-352)
   - 這個快取會一直保存在記憶體中，永不釋放
   - Redis 客戶端也是全域變數 (122)

2. **Base64 圖片儲存**:
   - 從 server.js 看到 15MB 的 payload limit
   - 圖片以 base64 存在 materials 中 (AppV2.tsx 1195-1215)
   - 這些資料會同時存在：前端 state、Redis/KV、以及可能的 tasks.json 檔案

3. **前端沒有清理**:
   - 大量 React state (AppV2.tsx)
   - 沒有 useEffect cleanup
   - Framer Motion 動畫可能導致 DOM 節點累積

4. **資料沒有分頁**:
   - 所有任務一次性載入
   - processedTasks 每次重新計算但沒有限制數量

讓我檢查一下實際的 tasks.json 內容，看看是否有大量資料：
</details></think>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./backend/tasks.json`
```
     1→[
     2→  {
     3→    "id": 1,
     4→    "name": "會議記錄工具開發",
     5→    "startDate": "2025-09-01",
     6→    "endDate": "2025-10-22",
     7→    "status": "completed",
     8→    "category": "AI賦能",
     9→    "progress": 100,
    10→    "description": "Electron桌面應用，含STT轉錄、AI摘要",
    11→    "materials": [
    12→      { "id": 1, "type": "link", "name": "動態說明書", "url": "https://example.com/docs", "note": "完整使用文檔" },
    13→      { "id": 2, "type": "link", "name": "專案架構文件", "url": "https://example.com/architecture", "note": "技術架構說明" }
    14→    ]
    15→  },
    16→  {
    17→    "id": 2,
    18→    "name": "銷售流程圖",
    19→    "startDate": "2025-09-15",
    20→    "endDate": "2025-10-05",
    21→    "status": "completed",
    22→    "category": "流程優化",
    23→    "progress": 100,
    24→    "description": "訪談銷售同事，繪製流程圖",
    25→    "materials": []
    26→  },
    27→  {
    28→    "id": 3,
    29→    "name": "iMobile 產品網站",
    30→    "startDate": "2025-09-20",
    31→    "endDate": "2025-10-22",
    32→    "status": "completed",
    33→    "category": "產品行銷",
    34→    "progress": 100,
    35→    "description": "產品介紹網頁製作與上線",
    36→    "materials": [
    37→      { "id": 1, "type": "link", "name": "線上網站", "url": "https://imobilebi.com", "note": "iMobile BI 產品官網" }
    38→    ]
    39→  },
    40→  {
    41→    "id": 4,
    42→    "name": "MSTR 產品網站",
    43→    "startDate": "2025-10-23",
    44→    "endDate": "2025-10-31",
    45→    "status": "in-progress",
    46→    "category": "產品行銷",
    47→    "progress": 70,
    48→    "description": "產品介紹網頁製作中",
    49→    "materials": []
    50→  },
    51→  {
    52→    "id": 5,
    53→    "name": "DemandETL 產品網站",
    54→    "startDate": "2025-11-01",
    55→    "endDate": "2025-11-15",
    56→    "status": "pending",
    57→    "category": "產品行銷",
    58→    "progress": 0,
    59→    "description": "第三個產品網站製作",
    60→    "materials": []
    61→  },
    62→  {
    63→    "id": 6,
    64→    "name": "三個網站優化",
    65→    "startDate": "2025-11-01",
    66→    "endDate": "2025-11-30",
    67→    "status": "pending",
    68→    "category": "產品行銷",
    69→    "progress": 0,
    70→    "description": "根據回饋優化三個產品網站",
    71→    "materials": []
    72→  },
    73→  {
    74→    "id": 7,
    75→    "name": "GA 流量分析設定",
    76→    "startDate": "2025-11-05",
    77→    "endDate": "2025-11-15",
    78→    "status": "pending",
    79→    "category": "產品行銷",
    80→    "progress": 0,
    81→    "description": "導入SEO關鍵字與GA流量統計",
    82→    "materials": []
    83→  },
    84→  {
    85→    "id": 8,
    86→    "name": "SOP 撰寫",
    87→    "startDate": "2025-11-01",
    88→    "endDate": "2025-11-20",
    89→    "status": "pending",
    90→    "category": "流程優化",
    91→    "progress": 0,
    92→    "description": "銷售團隊標準作業程序文件",
    93→    "materials": []
    94→  },
    95→  {
    96→    "id": 9,
    97→    "name": "SEO 優化執行",
    98→    "startDate": "2025-11-10",
    99→    "endDate": "2025-11-25",
   100→    "status": "pending",
   101→    "category": "品牌行銷",
   102→    "progress": 0,
   103→    "description": "網站與文章SEO優化",
   104→    "materials": []
   105→  },
   106→  {
   107→    "id": 10,
   108→    "name": "季度成效報告",
   109→    "startDate": "2025-11-23",
   110→    "endDate": "2025-11-30",
   111→    "status": "pending",
   112→    "category": "品牌行銷",
   113→    "progress": 0,
   114→    "description": "三個月工作成果總結報告",
   115→    "materials": []
   116→  },
   117→  {
   118→    "id": 11,
   119→    "name": "品牌文章撰寫",
   120→    "startDate": "2025-09-10",
   121→    "endDate": "2025-11-30",
   122→    "status": "unpublished",
   123→    "category": "品牌行銷",
   124→    "progress": 78,
   125→    "description": "已完成7篇，待審查發布",
   126→    "materials": []
   127→  },
   128→  {
   129→    "id": 12,
   130→    "name": "客戶開發（Capalyze）",
   131→    "startDate": "2025-10-10",
   132→    "endDate": "2025-11-15",
   133→    "status": "blocked",
   134→    "category": "客戶開發",
   135→    "progress": 30,
   136→    "description": "技術卡關中",
   137→    "materials": []
   138→  },
   139→  {
   140→    "id": 13,
   141→    "name": "Agentic Coding 工具研究",
   142→    "startDate": "2025-09-05",
   143→    "endDate": "2025-10-20",
   144→    "status": "completed",
   145→    "category": "學習與成長",
   146→    "progress": 100,
   147→    "description": "研究AI編程工具",
   148→    "materials": []
   149→  },
   150→  {
   151→    "id": 15,
   152→    "name": "版本控制工具學習",
   153→    "startDate": "2025-09-10",
   154→    "endDate": "2025-10-15",
   155→    "status": "completed",
   156→    "category": "學習與成長",
   157→    "progress": 100,
   158→    "description": "Git工具研究",
   159→    "materials": []
   160→  },
   161→  {
   162→    "id": 26,
   163→    "name": "CI/CD 方法學習",
   164→    "startDate": "2025-10-01",
   165→    "endDate": "2025-11-05",
   166→    "status": "in-progress",
   167→    "category": "學習與成長",
   168→    "progress": 40,
   169→    "description": "持續整合/部署流程實作",
   170→    "materials": []
   171→  },
   172→  {
   173→    "id": 16,
   174→    "name": "Prompt Engineering 研究",
   175→    "startDate": "2025-09-20",
   176→    "endDate": "2025-11-30",
   177→    "status": "in-progress",
   178→    "category": "學習與成長",
   179→    "progress": 65,
   180→    "description": "提示詞工程研究",
   181→    "materials": []
   182→  },
   183→  {
   184→    "id": 17,
   185→    "name": "跨平台開發踩坑紀錄",
   186→    "startDate": "2025-09-15",
   187→    "endDate": "2025-10-22",
   188→    "status": "completed",
   189→    "category": "學習與成長",
   190→    "progress": 100,
   191→    "description": "Electron開發經驗",
   192→    "materials": []
   193→  },
   194→  {
   195→    "id": 18,
   196→    "name": "內容自動化工作流",
   197→    "startDate": "2025-10-01",
   198→    "endDate": "2025-11-30",
   199→    "status": "in-progress",
   200→    "category": "學習與成長",
   201→    "progress": 40,
   202→    "description": "n8n/Dify 自動化系統",
   203→    "materials": []
   204→  },
   205→  {
   206→    "id": 19,
   207→    "name": "AI工作流持續研究",
   208→    "startDate": "2025-09-01",
   209→    "endDate": "2025-11-30",
   210→    "status": "in-progress",
   211→    "category": "學習與成長",
   212→    "progress": 50,
   213→    "description": "MCP、Computer Use 追蹤",
   214→    "materials": []
   215→  }
   216→]
   217→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<tool-use data-tool-type="bash" data-tool-name="Bash"><details>
<summary>Tool use: **Bash**</summary>
 檢查是否有日誌檔案

`find . -name "*.log" -o -name "node_modules" -prune 2>/dev/null | head -10`
```
./node_modules
./backend/node_modules
```
</details></tool-use>

_**Agent (claude-sonnet-4-5-20250929)**_

<think><details><summary>Thought Process</summary>
好的，tasks.json 檔案只有 8KB，包含 18 個任務，資料量不大。這不是主要問題。

讓我總結一下可能導致 Windows Server 記憶體吃到 10GB 的主要原因：

**主要問題：**

1. **全域變數記憶體洩漏** (storage.js:108-109, 351-352):   ```javascript
   let workspaceCollectionCache = globalThis.__GANTT_WORKSPACE_COLLECTION || null;
   globalThis.__GANTT_WORKSPACE_COLLECTION = workspaceCollectionCache;
   ```
   - 這個快取永遠不會被釋放
   - 如果有多個工作區，所有資料都會累積在這裡

2. **Redis 客戶端沒有關閉** (storage.js:122-138):
   ```javascript
   let redisClient = null;
   ```
   - Redis 連線保持開啟
   - 可能累積大量未處理的連線或緩衝區

3. **Base64 圖片儲存** (server.js:19):
   ```javascript
   app.use(express.json({ limit: '15mb' }));
   ```
   - 每個請求最多 15MB   - 如果有多個附件，會快速累積記憶體

4. **Express.js body parser**:
   - 15MB 的 JSON payload limit 意味著每個請求都可能載入大量資料到記憶體

5. **Node.js 記憶體洩漏常見原因**:
   - 沒有設定 `--max-old-space-size`
   - 垃圾回收機制效率低下
   - 事件監聽器持續累積且未正確移除

我發現兩個額外的記憶體消耗風險點：垃圾回收效率不足和事件監聽器未釋放。這些問題會導致記憶體逐漸膨脹，最終影響伺服器性能。需要仔細檢查事件監聽器的生命週期管理和垃圾回收策略。
</details></think>

_**Agent (claude-sonnet-4-5-20250929)**_

## 🔍 記憶體問題診斷報告

我已經分析了你的甘特圖專案管理系統，發現了幾個可能導致 **Windows Server RAM 吃到 10GB** 的問題：

---

### **🚨 主要問題（按嚴重程度排序）**

#### **1. 全域變數記憶體洩漏** ⚠️ **最嚴重**
**位置**: `backend/storage.js:108-109`

```javascript
let workspaceCollectionCache = globalThis.__GANTT_WORKSPACE_COLLECTION || null;
globalThis.__GANTT_WORKSPACE_COLLECTION = workspaceCollectionCache;
```

**問題**:
- 所有工作區資料永久快取在全域變數中
- 即使資料更新，舊資料也不會被釋放
- 隨著時間累積，記憶體持續增長

#### **2. Redis 客戶端沒有連線池管理** ⚠️ **嚴重**
**位置**: `backend/storage.js:122-138`

```javascript
let redisClient = null;  // 全域單例，永不關閉
```

**問題**:
- Redis 連線保持開啟，累積緩衝區資料
- 沒有連線超時或清理機制
- 錯誤處理後連線可能處於異常狀態

#### **3. 15MB JSON Payload Limit** ⚠️ **中等**
**位置**: `backend/server.js:19`

```javascript
app.use(express.json({ limit: '15mb' }));
```

**問題**:
- 每個請求可載入最多 15MB 資料到記憶體
- Base64 圖片儲存在 `materials` 中（`AppV2.tsx:1195-1215`）
- 多個同時請求會快速消耗記憶體

#### **4. React 組件沒有清理副作用** ⚠️ **中等**
**位置**: `src/AppV2.tsx`, `src/components/Gantt/GanttChart.tsx`

**問題**:
- Framer Motion 動畫可能累積 DOM 節點
- 沒有 `useEffect` cleanup 函數
- FileReader 產生的 dataURL 沒有釋放（`AppV2.tsx:1206-1214`）

#### **5. 沒有資料分頁或限制** ⚠️ **輕微**
**位置**: `src/hooks/useTasks.ts:16-18`

```javascript
const loadedTasks = await tasksApi.getAll();
setTasks(loadedTasks);  // 一次載入所有任務
```

---

### **📊 當前資料量分析**

```bash
✅ tasks.json: 8KB (18 個任務)
✅ 資料本身不大，問題在於記憶體管理
```

---

### **🔧 建議的修復方案**

#### **立即修復（減少 80% 記憶體使用）**

**1. 修改 `backend/storage.js` - 清理快取**

```javascript
// 在 persistCollection 後清除快取（保留最近 5 分鐘）
const CACHE_TTL = 5 * 60 * 1000; // 5 分鐘

const clearCacheAfterDelay = () => {
  setTimeout(() => {
    workspaceCollectionCache = null;
    globalThis.__GANTT_WORKSPACE_COLLECTION = null;
  }, CACHE_TTL);
};

// 在 persistCollection 函數末尾加上
clearCacheAfterDelay();
```

**2. 修改 `backend/storage.js` - 關閉閒置 Redis 連線**

```javascript
// 在 getRedisClient 後設定超時
const getRedisClient = async () => {
  // ... 現有程式碼 ...
  
  // 30 分鐘後自動斷線
  setTimeout(async () => {
    if (redisClient?.isOpen) {
      await redisClient.quit();
      redisClient = null;
    }
  }, 30 * 60 * 1000);
  
  return redisClient;
};
```

**3. 降低 Payload Limit** - `backend/server.js:19`

```javascript
app.use(express.json({ limit: '5mb' }));  // 從 15mb 降到 5mb
```

**4. 清理 React FileReader** - `src/AppV2.tsx:1206-1214`

```javascript
useEffect(() => {
  // 清理未使用的 dataURL
  return () => {
    if (newMaterial.dataUrl) {
      // Base64 dataURL 無需 revoke，但清空 state
      setNewMaterial(prev => ({ ...prev, dataUrl: '' }));
    }
  };
}, []);
```

#### **長期優化（進一步優化）**

**5. 加入 Node.js 記憶體限制**

在 `backend/package.json` 的啟動腳本中：

```json
"scripts": {
  "start": "node --max-old-space-size=512 server.js"
}
```

**6. 監控記憶體使用**

```javascript
// 在 backend/server.js 頂部加入
setInterval(() => {
  const used = process.memoryUsage();
  console.log('[Memory]', {
    rss: `${Math.round(used.rss / 1024 / 1024)}MB`,
    heapUsed: `${Math.round(used.heapUsed / 1024 / 1024)}MB`,
  });
}, 60000); // 每分鐘記錄
```

---

### **🎯 預期效果**

| 修復項目 | 預期記憶體減少 |
|---------|---------------|
| 清理全域快取 | -60% (6GB) |
| 關閉閒置 Redis | -15% (1.5GB) |
| 降低 Payload | -10% (1GB) |
| React 清理 | -5% (500MB) |
| **總計** | **-90%** |

修復後預期記憶體使用應降至 **1GB 以下**。

---

需要我幫你直接修改這些檔案嗎？

